# Security and Deployment Guide

> **Generated by**: BSM Autonomous Architect  
> **Date**: 2026-02-06  
> **Classification**: Internal Use

## Table of Contents

1. [Security Architecture](#security-architecture)
2. [Deployment Checklist](#deployment-checklist)
3. [Environment Configuration](#environment-configuration)
4. [Secret Management](#secret-management)
5. [Security Hardening](#security-hardening)
6. [Incident Response](#incident-response)
7. [Compliance and Audit](#compliance-and-audit)

---

## Security Architecture

### Defense in Depth Strategy

```
┌─────────────────────────────────────────────────────────────┐
│ Layer 1: Network Security                                   │
│ - Cloudflare DDoS protection                                │
│ - TLS 1.3 encryption                                        │
│ - DNS-level filtering                                       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 2: Application Gateway                                │
│ - Rate limiting (100 req/15min)                             │
│ - CORS validation                                           │
│ - Request size limits (1MB)                                 │
│ - Security headers (Helmet)                                 │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 3: Authentication & Authorization                     │
│ - Admin token authentication                                │
│ - Constant-time comparison                                  │
│ - Token length validation (16+ chars)                       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 4: Input Validation                                   │
│ - Type checking                                             │
│ - Length validation (4000 chars)                            │
│ - Content sanitization                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 5: Agent Permission System                            │
│ - Action whitelisting                                       │
│ - Intent validation                                         │
│ - Execution sandboxing                                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 6: External API Security                              │
│ - API key isolation                                         │
│ - Timeout enforcement (30s)                                 │
│ - Error handling                                            │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ Layer 7: Monitoring & Logging                               │
│ - Request correlation                                       │
│ - Error logging                                             │
│ - Security event tracking                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## Deployment Checklist

### Pre-Deployment

#### 1. Code Review ✓
- [ ] All PRs reviewed by at least one developer
- [ ] Security scan passed (CodeQL)
- [ ] Dependency audit clean (`npm audit`)
- [ ] No hardcoded secrets in code
- [ ] Error handling reviewed

#### 2. Testing ✓
- [ ] Unit tests passed
- [ ] Integration tests passed
- [ ] Validation script passed (`npm run validate`)
- [ ] Manual smoke testing completed

#### 3. Configuration ✓
- [ ] Environment variables documented
- [ ] Secrets configured in deployment platform
- [ ] CORS origins updated
- [ ] Rate limits configured appropriately
- [ ] Admin token is strong (16+ characters)

#### 4. Documentation ✓
- [ ] README updated
- [ ] API documentation current
- [ ] Deployment guide reviewed
- [ ] Changelog updated

### Deployment

#### 1. Staging Deployment
```bash
# 1. Deploy to staging
git checkout develop
git pull origin develop
git push origin develop

# 2. Wait for staging deployment
# Monitor: https://dashboard.render.com

# 3. Smoke test staging
curl https://staging.bsm.lexdo.uk/api/health
curl https://staging.bsm.lexdo.uk/api/agents
```

#### 2. Production Deployment
```bash
# 1. Create release branch
git checkout -b release/v1.x.x

# 2. Update version
npm version patch/minor/major

# 3. Merge to main
git checkout main
git merge release/v1.x.x
git push origin main

# 4. Tag release
git tag -a v1.x.x -m "Release version 1.x.x"
git push origin v1.x.x

# 5. Monitor deployment
# Check: https://dashboard.render.com
# Verify: https://bsm.lexdo.uk/api/health
```

### Post-Deployment

#### 1. Verification ✓
- [ ] Health check endpoint responding
- [ ] All API endpoints functional
- [ ] Admin UI accessible
- [ ] Chat UI loading correctly
- [ ] Agents executing successfully

#### 2. Monitoring ✓
- [ ] Log aggregation working
- [ ] Error tracking active
- [ ] Performance metrics baseline recorded
- [ ] Alerts configured

#### 3. Rollback Plan ✓
- [ ] Previous version tagged
- [ ] Rollback procedure documented
- [ ] Team notified of deployment

---

## Environment Configuration

### Environment Variables Reference

#### Required Variables

```bash
# Admin Authentication
ADMIN_TOKEN=<strong-random-token-16-plus-chars>
```

#### Recommended Variables

```bash
# Environment
NODE_ENV=production
PORT=3000
LOG_LEVEL=info

# OpenAI API Keys
OPENAI_BSM_KEY=sk-...
OPENAI_BRINDER_KEY=sk-...
OPENAI_LEXNEXUS_KEY=sk-...
OPENAI_MODEL=gpt-4o-mini

# CORS Configuration
CORS_ORIGINS=https://www.lexdo.uk,https://admin.lexdo.uk

# Rate Limiting
RATE_LIMIT_WINDOW_MS=900000  # 15 minutes
RATE_LIMIT_MAX=100

# Agent Configuration
MAX_AGENT_INPUT_LENGTH=4000
```

### Environment-Specific Configuration

#### Development
```env
NODE_ENV=development
LOG_LEVEL=debug
ADMIN_TOKEN=dev-token-for-testing
CORS_ORIGINS=http://localhost:3000,http://localhost:8080
```

#### Staging
```env
NODE_ENV=staging
LOG_LEVEL=info
ADMIN_TOKEN=<staging-token>
CORS_ORIGINS=https://staging.lexdo.uk
```

#### Production
```env
NODE_ENV=production
LOG_LEVEL=warn
ADMIN_TOKEN=<production-strong-token>
CORS_ORIGINS=https://www.lexdo.uk,https://admin.lexdo.uk
```

---

## Secret Management

### Secret Generation

#### Generate Strong Admin Token
```bash
# Option 1: Using OpenSSL
openssl rand -base64 32

# Option 2: Using Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# Option 3: Using Python
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

#### Generate API Keys
```bash
# OpenAI API keys must be obtained from OpenAI dashboard
# https://platform.openai.com/api-keys
```

### Secret Storage

#### Local Development
```bash
# Create .env file (never commit!)
cp .env.example .env
nano .env
```

#### Render.com
1. Navigate to Service → Environment
2. Add environment variables
3. Click "Save Changes"
4. Service will auto-redeploy

#### GitHub Actions
1. Repository Settings → Secrets and variables → Actions
2. Add repository secret
3. Use in workflow: `${{ secrets.SECRET_NAME }}`

### Secret Rotation

#### Rotation Schedule
- Admin tokens: Every 90 days
- OpenAI API keys: On team member departure or suspected leak
- All secrets: Immediately upon security incident

#### Rotation Procedure
```bash
# 1. Generate new secret
NEW_TOKEN=$(openssl rand -base64 32)

# 2. Update in deployment platform
# (Render dashboard or CLI)

# 3. Test with new secret
curl -H "x-admin-token: $NEW_TOKEN" https://bsm.lexdo.uk/api/admin/agents

# 4. Document rotation in changelog
echo "$(date): Admin token rotated" >> security-changelog.txt

# 5. Notify team
# Send notification to team communication channel
```

---

## Security Hardening

### Application Security

#### 1. Helmet Configuration Enhancement

**Current**: Default Helmet settings  
**Recommended**: Custom CSP

```javascript
// src/app.js
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://cdn.jsdelivr.net"],
      imgSrc: ["'self'", "data:", "https:"],
      connectSrc: ["'self'", "https://api.openai.com"],
      fontSrc: ["'self'", "https://cdn.jsdelivr.net"],
      objectSrc: ["'none'"],
      upgradeInsecureRequests: []
    }
  },
  hsts: {
    maxAge: 31536000,
    includeSubDomains: true,
    preload: true
  }
}));
```

#### 2. Enhanced Rate Limiting

**Add**: IP-based tracking with Redis

```javascript
// Recommended: Use rate-limit-redis store
import rateLimit from "express-rate-limit";
import RedisStore from "rate-limit-redis";
import Redis from "ioredis";

const client = new Redis(process.env.REDIS_URL);

app.use("/api", rateLimit({
  store: new RedisStore({
    client: client,
    prefix: "rl:"
  }),
  windowMs: 15 * 60 * 1000,
  max: 100,
  standardHeaders: true,
  legacyHeaders: false,
  handler: (req, res) => {
    res.status(429).json({
      error: "Too many requests",
      retryAfter: req.rateLimit.resetTime
    });
  }
}));
```

#### 3. Input Sanitization

**Add**: Input sanitization middleware

```javascript
// src/middleware/sanitize.js
import createDOMPurify from "isomorphic-dompurify";

const sanitize = (input) => {
  if (typeof input !== "string") return input;
  return createDOMPurify.sanitize(input);
};

export const sanitizeInput = (req, res, next) => {
  if (req.body) {
    Object.keys(req.body).forEach(key => {
      req.body[key] = sanitize(req.body[key]);
    });
  }
  next();
};
```

#### 4. API Key Validation

**Add**: OpenAI API key validation on startup

```javascript
// src/config/models.js
import fetch from "node-fetch";

export const validateApiKeys = async () => {
  const keys = [
    { name: "BSM", key: process.env.OPENAI_BSM_KEY },
    { name: "Brinder", key: process.env.OPENAI_BRINDER_KEY },
    { name: "LexNexus", key: process.env.OPENAI_LEXNEXUS_KEY }
  ];

  for (const { name, key } of keys) {
    if (!key) continue;
    
    try {
      const response = await fetch("https://api.openai.com/v1/models", {
        headers: { "Authorization": `Bearer ${key}` }
      });
      
      if (!response.ok) {
        console.error(`Invalid ${name} API key`);
      }
    } catch (err) {
      console.error(`Failed to validate ${name} API key:`, err);
    }
  }
};
```

### Infrastructure Security

#### 1. TLS Configuration

**Ensure**: TLS 1.3 only, strong ciphers

**Render.com**: Automatically configured ✓  
**Cloudflare**: Configure in SSL/TLS settings

#### 2. Firewall Rules

**Recommended**: Cloudflare WAF rules

```
# Block suspicious user agents
(http.user_agent contains "sqlmap")
(http.user_agent contains "nikto")
(http.user_agent contains "nmap")

# Block countries (if needed)
(ip.geoip.country in {"XX" "YY"})

# Rate limit aggressive IPs
(rate(ip.src, 1m) > 300)
```

#### 3. DDoS Protection

**Enable**: Cloudflare DDoS protection  
**Configure**: Under-attack mode for emergencies

---

## Incident Response

### Security Incident Playbook

#### Phase 1: Detection and Analysis

1. **Identify Incident**
   - Monitor logs for suspicious activity
   - Review error rates and patterns
   - Check security scan results

2. **Assess Severity**
   - Critical: Production down, data breach
   - High: Service degraded, attempted breach
   - Medium: Vulnerability discovered
   - Low: Minor security issue

#### Phase 2: Containment

**Immediate Actions**:
```bash
# 1. Enable maintenance mode (if available)
# 2. Block suspicious IPs via Cloudflare
# 3. Rotate compromised credentials
# 4. Disable affected features
```

**Short-term Containment**:
```bash
# 1. Apply temporary patches
# 2. Increase monitoring
# 3. Document all actions
# 4. Notify stakeholders
```

#### Phase 3: Eradication

```bash
# 1. Identify root cause
# 2. Remove malicious code/access
# 3. Patch vulnerabilities
# 4. Update dependencies
npm audit fix --force
npm update
```

#### Phase 4: Recovery

```bash
# 1. Deploy fixes to staging
# 2. Test thoroughly
# 3. Deploy to production
# 4. Verify systems operational
# 5. Monitor closely for 24-48 hours
```

#### Phase 5: Post-Incident Review

1. Document incident timeline
2. Analyze response effectiveness
3. Update playbooks
4. Implement preventive measures
5. Conduct team debrief

### Common Incident Scenarios

#### Scenario 1: Leaked API Key

**Response**:
```bash
# 1. Rotate key immediately
# 2. Review OpenAI usage logs
# 3. Check for unauthorized usage
# 4. Update key in all environments
# 5. Add key to .gitignore (verify)
# 6. Scan git history for exposed keys
git log -S "sk-" --all
```

#### Scenario 2: Brute Force Attack

**Response**:
```bash
# 1. Identify attack pattern in logs
# 2. Block attacking IPs
# 3. Reduce rate limits temporarily
# 4. Rotate admin token
# 5. Enable CAPTCHA (if available)
```

#### Scenario 3: DDoS Attack

**Response**:
```bash
# 1. Enable Cloudflare "Under Attack" mode
# 2. Scale infrastructure if possible
# 3. Monitor resource usage
# 4. Contact Cloudflare/Render support
# 5. Communicate status to users
```

---

## Compliance and Audit

### Security Audit Checklist

#### Code Security
- [ ] No hardcoded secrets
- [ ] Input validation on all endpoints
- [ ] Error messages don't leak sensitive info
- [ ] Dependencies up to date
- [ ] No known vulnerabilities

#### Access Control
- [ ] Admin endpoints require authentication
- [ ] Token comparison is constant-time
- [ ] CORS configured correctly
- [ ] Rate limiting active

#### Data Protection
- [ ] TLS enabled (HTTPS only)
- [ ] Secrets stored securely
- [ ] Logs don't contain sensitive data
- [ ] No PII in error messages

#### Infrastructure
- [ ] Firewall configured
- [ ] DDoS protection active
- [ ] Backup strategy in place
- [ ] Monitoring and alerting configured

### Logging and Audit Trail

#### What to Log

**Log** ✓:
- Authentication attempts (success/failure)
- Admin operations
- Agent executions
- API errors
- Rate limit violations
- Configuration changes

**Don't Log** ✗:
- Passwords or tokens
- Full API keys
- Personal identifiable information (PII)
- Credit card numbers
- Session tokens

#### Log Retention

- Development: 7 days
- Staging: 30 days
- Production: 90 days
- Security logs: 1 year

#### Log Analysis

```bash
# Find failed auth attempts
grep "authentication failed" logs/*.log

# Find rate limit violations
grep "rate limit exceeded" logs/*.log

# Find errors
grep "ERROR" logs/*.log | tail -100
```

---

## Security Best Practices Summary

### Do ✓

✓ Use strong, unique admin tokens (16+ characters)  
✓ Rotate secrets regularly (every 90 days)  
✓ Keep dependencies updated  
✓ Enable all security middleware  
✓ Use HTTPS only  
✓ Log security events  
✓ Monitor for suspicious activity  
✓ Test security controls regularly  
✓ Document security procedures  
✓ Train team on security practices  

### Don't ✗

✗ Commit secrets to git  
✗ Use weak admin tokens  
✗ Expose detailed error messages  
✗ Disable security middleware  
✗ Trust user input without validation  
✗ Share admin credentials  
✗ Log sensitive data  
✗ Ignore security warnings  
✗ Skip security reviews  
✗ Deploy without testing  

---

## Emergency Contacts

### Internal Team
- **Security Lead**: [Contact Info]
- **DevOps Lead**: [Contact Info]
- **On-Call Engineer**: [Rotation Schedule]

### External Services
- **Render Support**: support@render.com
- **Cloudflare Support**: [Support Portal]
- **OpenAI Support**: support@openai.com

### Escalation Path

1. On-call engineer (immediate)
2. Security lead (within 1 hour)
3. DevOps lead (within 2 hours)
4. Management (for critical incidents)

---

## Appendix

### Security Tools

- **npm audit**: Dependency vulnerability scanning
- **Snyk**: Advanced security scanning
- **CodeQL**: Static code analysis
- **OWASP ZAP**: Dynamic application security testing

### Useful Commands

```bash
# Security audit
npm audit
npm audit fix

# Check for outdated packages
npm outdated

# Update all dependencies
npm update

# Check for vulnerabilities in specific package
npm audit <package-name>

# Generate security report
npm audit --json > security-report.json
```

---

**Document Owner**: Security Team  
**Review Schedule**: Quarterly  
**Last Updated**: 2026-02-06  
**Next Review**: May 2026
