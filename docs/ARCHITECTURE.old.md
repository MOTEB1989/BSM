# BSU Platform - Architecture Documentation

> **Generated by**: BSU Autonomous Architect  
> **Date**: 2026-02-06  
> **Version**: 1.0.0

## Executive Summary

The **BSU (Business Service Management) Platform** is an AI-powered knowledge management and legal services platform built with Node.js and Express. It provides intelligent agent-based services using OpenAI GPT models, with a focus on Arabic and English language support for legal and governance operations.

### Key Metrics
- **Total Source Lines**: ~900 lines of JavaScript
- **Main Components**: 28 source files
- **Largest Module**: Chat UI (221 lines)
- **API Endpoints**: 10+ routes
- **Agent Types**: 2 configured (legal-agent, governance-agent)

---

## Architectural Overview

### High-Level Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     Client Layer                            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  Admin UI    │  │   Chat UI    │  │ GitHub Pages │     │
│  │  (HTML/JS)   │  │  (Vue 3)     │  │   Frontend   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                          │  HTTP/REST
┌─────────────────────────────────────────────────────────────┐
│                   API Gateway Layer                         │
│  ┌──────────────────────────────────────────────────┐      │
│  │  Express.js App (app.js)                         │      │
│  │  - CORS, Helmet, Rate Limiting                   │      │
│  │  - Request Logging & Correlation                 │      │
│  │  - Authentication Middleware                     │      │
│  └──────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────────┐
│                    Routing Layer                            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │ Health  │ │ Agents  │ │  Chat   │ │  Admin  │          │
│  │ Routes  │ │ Routes  │ │ Routes  │ │ Routes  │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
└─────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────────┐
│                  Controller Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Health     │  │   Agents     │  │  Knowledge   │     │
│  │ Controller   │  │ Controller   │  │ Controller   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────────┐
│                   Service Layer                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Agents     │  │  Knowledge   │  │     GPT      │     │
│  │   Service    │  │   Service    │  │   Service    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────────┐
│                 Integration Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ Agent Runner │  │ GitHub       │  │   OpenAI     │     │
│  │              │  │ Actions      │  │  API Client  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                          │
┌─────────────────────────────────────────────────────────────┐
│                    Data Layer                               │
│  ┌──────────────┐  ┌──────────────┐                        │
│  │   Agents     │  │  Knowledge   │                        │
│  │ (YAML files) │  │ (Markdown)   │                        │
│  └──────────────┘  └──────────────┘                        │
└─────────────────────────────────────────────────────────────┘
```

---

## Directory Structure

### `/src` - Application Source

```
src/
├── actions/            # External integrations
│   └── githubActions.js    # GitHub API operations
├── admin/              # Admin UI (static HTML/JS)
│   └── app.js             # Admin dashboard logic
├── chat/               # Chat UI (Vue 3 + Tailwind)
│   └── app.js             # Vue 3 chat application
├── config/             # Configuration modules
│   ├── env.js             # Environment variables
│   └── models.js          # AI model configurations
├── controllers/        # Request handlers
│   ├── agentsController.js    # Agent execution endpoints
│   ├── healthController.js    # Health check endpoint
│   └── knowledgeController.js # Knowledge retrieval
├── middleware/         # Express middleware
│   ├── auth.js            # Authentication (admin token)
│   ├── correlation.js     # Request correlation IDs
│   ├── errorHandler.js    # Global error handling
│   ├── notFound.js        # 404 handler
│   └── requestLogger.js   # HTTP request logging
├── routes/             # API route definitions
│   ├── admin.js           # Admin API routes
│   ├── agents.js          # Agent API routes
│   ├── chat.js            # Chat API routes
│   ├── health.js          # Health check route
│   ├── index.js           # Route aggregator
│   └── knowledge.js       # Knowledge API routes
├── runners/            # Execution engines
│   └── agentRunner.js     # Agent orchestration logic
├── services/           # Business logic
│   ├── agentsService.js   # Agent YAML loading
│   ├── gptService.js      # OpenAI API integration
│   └── knowledgeService.js # Knowledge document loading
├── utils/              # Utility functions
│   ├── errors.js          # Custom error classes
│   ├── fsSafe.js          # Safe file system operations
│   ├── intent.js          # Intent extraction & action mapping
│   └── logger.js          # Pino logger configuration
├── app.js              # Express app configuration
└── server.js           # Server entry point
```

### `/data` - Configuration Data

```
data/
├── agents/             # Agent configurations
│   ├── index.json         # Agent file registry
│   ├── legal-agent.yaml   # Legal services agent
│   └── governance-agent.yaml # Governance agent
└── knowledge/          # Knowledge base
    ├── index.json         # Knowledge file registry
    └── example.md         # Example knowledge document
```

### `/.github` - CI/CD and Agent Definitions

```
.github/
├── agents/             # GitHub Copilot agent definitions
│   ├── bsm-autonomous-architect.agent.md
│   ├── orchestrator.agent.md
│   ├── runner.agent.md
│   └── security.agent.md
├── workflows/          # GitHub Actions workflows
│   ├── agents-run.yml     # Agent execution workflow
│   ├── codeql-analysis.yml # Security scanning
│   ├── pages.yml          # GitHub Pages deployment
│   └── validate.yml       # Data validation
└── PULL_REQUEST_TEMPLATE/
    └── agents-suggestions.md # PR template
```

---

## Core Components

### 1. Application Layer (`src/app.js`)

**Purpose**: Express.js application configuration and middleware orchestration.

**Key Features**:
- CORS configuration with optional origin whitelist
- Helmet for security headers
- Rate limiting (configurable window and max requests)
- JSON body parser with 1MB limit
- Request correlation ID tracking
- Static file serving for Admin and Chat UIs

**Security Features**:
- Request size limiting (1MB)
- Rate limiting on `/api` endpoints
- Admin token authentication for protected routes
- CORS protection with origin validation

### 2. Routing Layer (`src/routes/`)

**Routes Overview**:

| Route | Purpose | Authentication |
|-------|---------|----------------|
| `GET /api/health` | Health check | None |
| `GET /api/agents` | List available agents | None |
| `POST /api/agents/run` | Execute an agent | None |
| `POST /api/chat` | Agent-based chat | None |
| `POST /api/chat/direct` | Direct GPT chat | None |
| `GET /api/knowledge` | List knowledge documents | None |
| `GET /api/admin/*` | Admin operations | Admin token |
| `/admin` | Admin UI | Admin token |
| `/chat` | Chat UI | None |

### 3. Agent System

#### Agent Configuration (YAML)

Agents are defined in YAML files with the following structure:

```yaml
id: legal-agent
name: Legal Services Agent
role: Provides legal analysis and document review
modelProvider: openai
modelKey: lexnexus
modelName: gpt-4o-mini
actions:
  - create_file
```

#### Agent Execution Flow

```
User Request → Controller → Agent Runner → GPT Service → Response
                ↓                ↓
           Validation      Load Knowledge
                                ↓
                         Extract Intent
                                ↓
                         Execute Action (if allowed)
```

#### Intent System

The platform includes an intent extraction and action mapping system:

**Supported Intents**:
- `create_agent` - Create a new agent configuration
- `update_file` - Update an existing file (not implemented)
- `create_file` - Create a new file via GitHub Actions

**Action Permissions**:
- Agents must explicitly list allowed actions
- Action validation occurs before execution
- Prevents unauthorized operations

### 4. Knowledge Management

**Knowledge Structure**:
- Documents stored in `data/knowledge/`
- Index file (`index.json`) lists available documents
- Markdown format for human readability
- Loaded and injected into agent prompts

**Knowledge Loading Process**:
1. Read `index.json`
2. Load each referenced file
3. Parse markdown content
4. Combine into knowledge context
5. Inject into GPT prompts

### 5. GPT Integration (`src/services/gptService.js`)

**Features**:
- OpenAI API integration
- Multiple API key support (BSM, Brinder, LexNexus)
- Configurable model selection
- System and user prompt construction
- 30-second timeout for API calls
- Error handling and retry logic

**Model Configuration**:
```javascript
{
  openai: {
    bsm: process.env.OPENAI_BSM_KEY,
    brinder: process.env.OPENAI_BRINDER_KEY,
    lexnexus: process.env.OPENAI_LEXNEXUS_KEY,
    default: process.env.OPENAI_BSM_KEY
  }
}
```

### 6. Logging and Monitoring

**Logger** (`src/utils/logger.js`):
- Pino logger with configurable log levels
- Pretty printing in development
- JSON logging in production
- Correlation ID tracking for request tracing

**Request Logging**:
- HTTP method, URL, status code
- Response time
- Correlation ID
- Error details

---

## Security Architecture

### Authentication

**Admin Token Authentication**:
- Environment variable: `ADMIN_TOKEN`
- Required for admin endpoints and UI
- Constant-time comparison to prevent timing attacks
- Multiple authentication methods:
  - Header: `x-admin-token`
  - Basic Auth: `admin:{token}`
  - Query param: `?token={token}`

**Production Requirements**:
- `ADMIN_TOKEN` must be set
- Minimum 16 characters
- Strong token validation on startup

### Input Validation

**Request Validation**:
- Agent ID: required, string type
- Input: required, string type, max length (default 4000 chars)
- JSON body size limit: 1MB

### Rate Limiting

**Configuration**:
- Window: 15 minutes (configurable)
- Max requests: 100 per window (configurable)
- Applied to all `/api` endpoints
- Standard headers for client feedback

### Security Headers

**Helmet Middleware**:
- Content Security Policy
- X-Frame-Options
- X-Content-Type-Options
- Strict-Transport-Security
- X-XSS-Protection

---

## Data Flow Patterns

### Agent Execution Pattern

```
┌─────────────┐
│ POST Request│
│ /api/agents/│
│    run      │
└──────┬──────┘
       │
       ▼
┌──────────────────┐
│ Validate Input   │
│ - agentId        │
│ - input length   │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Load Agent Config│
│ (YAML parsing)   │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Load Knowledge   │
│ (Markdown files) │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Construct Prompts│
│ - System         │
│ - User + Context │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Call OpenAI API  │
│ (with timeout)   │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Extract Intent   │
│ & Validate Action│
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Execute Action   │
│ (if permitted)   │
└──────┬───────────┘
       │
       ▼
┌──────────────────┐
│ Return Response  │
│ with correlationId│
└──────────────────┘
```

### Chat Pattern

```
┌─────────────┐
│ POST /chat  │
│ - agentId   │
│ - input     │
└──────┬──────┘
       │
       ▼
┌──────────────────┐
│ Agent-based Chat │
│ (uses runAgent)  │
└──────────────────┘
```

```
┌─────────────────┐
│ POST /chat/     │
│    direct       │
│ - messages[]    │
└──────┬──────────┘
       │
       ▼
┌──────────────────┐
│ Direct GPT Chat  │
│ (no agent config)│
│ - conversation   │
│   history        │
└──────────────────┘
```

---

## Configuration Management

### Environment Variables

**Required**:
- `ADMIN_TOKEN` - Admin authentication token (production: 16+ chars)

**Optional**:
- `NODE_ENV` - Environment (default: development)
- `PORT` - Server port (default: 3000)
- `LOG_LEVEL` - Logging level (default: info)
- `OPENAI_BSM_KEY` - OpenAI API key for BSM
- `OPENAI_BRINDER_KEY` - OpenAI API key for Brinder
- `OPENAI_LEXNEXUS_KEY` - OpenAI API key for LexNexus
- `OPENAI_MODEL` - Default model (default: gpt-4o-mini)
- `CORS_ORIGINS` - Comma-separated allowed origins
- `RATE_LIMIT_WINDOW_MS` - Rate limit window (default: 900000)
- `RATE_LIMIT_MAX` - Max requests per window (default: 100)
- `MAX_AGENT_INPUT_LENGTH` - Max input characters (default: 4000)

### Model Configuration

Multiple API keys support different use cases:
- **BSU**: Primary platform key
- **Brinder**: Specific service integration
- **LexNexus**: Legal services specialization

---

## Error Handling

### Custom Error Class

```javascript
class AppError extends Error {
  constructor(message, statusCode, code) {
    super(message);
    this.statusCode = statusCode;
    this.code = code;
  }
}
```

### Error Response Format

```json
{
  "error": "Error message",
  "code": "ERROR_CODE",
  "correlationId": "uuid-v4"
}
```

### Error Logging

All errors are logged with:
- Error message and stack trace
- Correlation ID
- Context (agentId, input, etc.)
- Timestamp

---

## Testing and Validation

### Data Validation (`scripts/validate.js`)

**Checks**:
- `data/agents/` directory exists
- `index.json` contains valid agent list
- All referenced agent files exist
- Agent YAML structure is valid
- Agent actions are in allowed set

**Allowed Actions**:
- `create_file`

### CI/CD Validation

**GitHub Actions Workflows**:

1. **Validate** (`validate.yml`)
   - Runs on PR and push to main
   - Installs dependencies
   - Executes validation script

2. **CodeQL** (`codeql-analysis.yml`)
   - Security code scanning
   - JavaScript analysis
   - Vulnerability detection

3. **Pages** (`pages.yml`)
   - Deploys `docs/` to GitHub Pages
   - Runs on push to main

4. **Agents Run** (`agents-run.yml`)
   - Custom agent execution workflow

---

## Deployment Architecture

### Supported Platforms

**Primary**: Render.com
- Configuration: `render.yaml`
- Auto-deployment from main branch
- Environment variable management
- Health check support

**Frontend**: GitHub Pages
- Hosted at `https://www.lexdo.uk`
- Static Vue 3 application
- Connects to API backend
- Custom domain with DNS configuration

### DNS Management

**Cloudflare Integration**:
- Zone file: `dns/lexdo-uk-zone.txt`
- Automated DNS setup scripts
- GitHub Pages verification
- Custom domain configuration

---

## Performance Considerations

### Current Optimizations

1. **Caching**:
   - Agent configurations loaded once per request (could be cached)
   - Knowledge base loaded once per request (could be cached)

2. **Rate Limiting**:
   - Protects against API abuse
   - Configurable thresholds

3. **Request Timeouts**:
   - 30-second OpenAI API timeout
   - Prevents hanging requests

### Potential Improvements

1. **Agent Configuration Caching**:
   - Cache parsed YAML in memory
   - Invalidate on file changes
   - Reduce disk I/O

2. **Knowledge Base Caching**:
   - Cache loaded knowledge documents
   - Invalidate on updates
   - Reduce parsing overhead

3. **Connection Pooling**:
   - HTTP client connection pooling for OpenAI API
   - Reduce connection overhead

4. **Async Processing**:
   - Queue system for long-running agent tasks
   - WebSocket support for real-time updates

---

## Scalability Considerations

### Current Architecture

**Strengths**:
- Stateless design (easy horizontal scaling)
- Modular structure
- File-based configuration (no database dependency)

**Limitations**:
- File-based storage (not suitable for high concurrency)
- No caching layer
- Synchronous agent execution
- Single process execution

### Scaling Recommendations

#### Immediate (0-100 concurrent users)
- Add in-memory caching for agent configs
- Implement connection pooling
- Optimize knowledge loading

#### Short-term (100-1000 concurrent users)
- Add Redis for distributed caching
- Implement worker queue (Bull, BullMQ)
- Add load balancer (multiple instances)
- Move to database for agents/knowledge

#### Long-term (1000+ concurrent users)
- Microservices architecture
- Dedicated agent execution service
- Separate GPT service
- Distributed tracing (OpenTelemetry)
- Message queue (RabbitMQ, Kafka)

---

## Code Quality and Standards

### Coding Conventions (from repository memories)

**String Literals**:
- ✅ Use double quotes: `"string"`
- ❌ Avoid single quotes: `'string'`

**Error Variables**:
- ✅ Use `err` for error variables
- ❌ Avoid `e` or other abbreviations

**Error Logging**:
- Always log errors in catch blocks
- Use the logger utility
- Include context (correlation ID, agent ID, etc.)

### Code Organization

**Module Structure**:
- ES6 modules (`import`/`export`)
- Clear separation of concerns
- Middleware pattern
- Service layer abstraction

**File Naming**:
- camelCase for JavaScript files
- Descriptive names (e.g., `agentsController.js`)
- Consistent patterns across directories

---

## Integration Points

### External Services

1. **OpenAI API**
   - Purpose: GPT model inference
   - Timeout: 30 seconds
   - Error handling: Graceful degradation

2. **GitHub API** (via githubActions.js)
   - Purpose: File creation/updates
   - Authentication: GitHub token
   - Operations: Create files in repository

### Frontend Integration

1. **Admin UI**
   - Static HTML/CSS/JS
   - Vanilla JavaScript
   - Token-based authentication

2. **Chat UI**
   - Vue 3 framework
   - Tailwind CSS
   - Configurable API URL
   - Supports both agent and direct chat modes

3. **GitHub Pages Frontend**
   - Standalone deployment
   - Same Vue 3 application
   - Custom domain (lexdo.uk)

---

## Monitoring and Observability

### Current Implementation

**Logging**:
- Pino logger (high-performance)
- Structured JSON logs in production
- Pretty-printed logs in development
- Log levels: trace, debug, info, warn, error, fatal

**Request Tracking**:
- Correlation IDs (UUID v4)
- Attached to all requests
- Included in responses
- Logged with all operations

**Health Checks**:
- `GET /api/health` endpoint
- Returns uptime and status
- Used by deployment platforms

### Recommended Enhancements

1. **Metrics Collection**:
   - Prometheus/StatsD integration
   - Request rate, latency, error rate
   - Agent execution metrics
   - OpenAI API usage tracking

2. **Distributed Tracing**:
   - OpenTelemetry integration
   - Trace agent execution flow
   - Monitor external API calls

3. **Alerting**:
   - Error rate thresholds
   - API latency alerts
   - Failed agent executions

4. **Dashboards**:
   - Grafana for metrics visualization
   - Request volume and patterns
   - Agent usage statistics

---

## Security Best Practices

### Current Implementation

✅ **Authentication**:
- Token-based admin authentication
- Constant-time comparison
- Production token length validation

✅ **Input Validation**:
- Request payload validation
- Input length limits
- Type checking

✅ **Security Headers**:
- Helmet middleware
- CORS configuration
- CSP policies

✅ **Rate Limiting**:
- API endpoint throttling
- Configurable limits

✅ **Error Handling**:
- No sensitive data in error messages
- Structured error responses
- Comprehensive logging

### Recommended Enhancements

1. **Secret Management**:
   - Use secret management service (Vault, AWS Secrets Manager)
   - Rotate API keys regularly
   - Audit secret access

2. **API Security**:
   - Implement API versioning
   - Add request signing
   - Implement OAuth2 for frontend

3. **Data Protection**:
   - Encrypt sensitive data at rest
   - Use HTTPS only (enforce in production)
   - Implement data retention policies

4. **Security Scanning**:
   - Dependency vulnerability scanning (Snyk, npm audit)
   - Regular CodeQL scans (already implemented)
   - SAST/DAST integration

---

## Future Enhancements

### Short-Term

1. **Agent Improvements**:
   - Add more intent types
   - Implement file update operations
   - Add agent templates
   - Support agent versioning

2. **Knowledge Base**:
   - Add search functionality
   - Implement tagging system
   - Support multiple formats (PDF, DOCX)
   - Add knowledge versioning

3. **User Experience**:
   - WebSocket support for real-time updates
   - Streaming responses
   - Multi-language UI improvements
   - Mobile-responsive admin UI

### Long-Term

1. **Advanced Features**:
   - Multi-agent orchestration
   - Agent-to-agent communication
   - Workflow automation
   - Custom action plugins

2. **Enterprise Features**:
   - Multi-tenancy support
   - Role-based access control (RBAC)
   - Audit logging
   - Compliance reporting

3. **AI Enhancements**:
   - Fine-tuned models for legal domain
   - RAG (Retrieval-Augmented Generation)
   - Vector database integration (Pinecone, Weaviate)
   - Custom embeddings

---

## Conclusion

The BSM platform is a well-structured, modular AI-powered application with a clear separation of concerns and solid security foundations. The architecture supports horizontal scaling and easy maintenance, with room for significant enhancements as usage grows.

### Strengths

✅ Clean modular architecture  
✅ Comprehensive security measures  
✅ Extensible agent system  
✅ Good error handling and logging  
✅ CI/CD automation  
✅ Multiple deployment options  

### Areas for Improvement

⚠️ Add caching layer for performance  
⚠️ Implement database for scalability  
⚠️ Add metrics and monitoring  
⚠️ Enhance test coverage  
⚠️ Implement async processing  

---

**Document Maintained By**: BSU Autonomous Architect  
**Last Updated**: 2026-02-06  
**Next Review**: Q2 2026
