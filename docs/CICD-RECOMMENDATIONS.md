# CI/CD Enhancement Recommendations

> **Generated by**: BSM Autonomous Architect  
> **Date**: 2026-02-06  
> **Priority**: High

## Current State Assessment

### Existing CI/CD Pipeline

The BSM platform currently has 4 GitHub Actions workflows:

1. **Validate** (`validate.yml`) - ✅ Active
2. **CodeQL Analysis** (`codeql-analysis.yml`) - ✅ Active  
3. **Pages Deployment** (`pages.yml`) - ✅ Active
4. **Agents Run** (`agents-run.yml`) - ⚠️ Needs review

### Gaps Identified

❌ No automated testing  
❌ No linting automation  
❌ No dependency scanning  
❌ No deployment automation (beyond Pages)  
❌ No staging environment  
❌ No rollback mechanism  
❌ No performance testing  
❌ No load testing  

---

## Recommended Enhancements

### Priority 1: Essential (Implement Immediately)

#### 1.1 Automated Testing Pipeline

**Create**: `.github/workflows/test.yml`

```yaml
name: Test

on:
  pull_request:
  push:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        node-version: [20, 22]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm ci
      - run: npm run validate
      - run: npm test
        if: ${{ hashFiles('test/**') != '' }}
      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: matrix.node-version == 22
        with:
          files: ./coverage/lcov.info
```

**Benefits**:
- Multi-version Node.js testing
- Code coverage tracking
- Early bug detection

#### 1.2 Linting and Code Quality

**Create**: `.github/workflows/lint.yml`

```yaml
name: Lint

on:
  pull_request:
  push:
    branches: [main, develop]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run format:check
```

**Required**: Add to `package.json`:

```json
{
  "scripts": {
    "lint": "eslint src/**/*.js",
    "lint:fix": "eslint src/**/*.js --fix",
    "format": "prettier --write \"src/**/*.js\"",
    "format:check": "prettier --check \"src/**/*.js\""
  },
  "devDependencies": {
    "eslint": "^8.57.0",
    "prettier": "^3.2.5"
  }
}
```

#### 1.3 Dependency Security Scanning

**Create**: `.github/workflows/security.yml`

```yaml
name: Security Scan

on:
  pull_request:
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm audit --audit-level=moderate
      
  snyk:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=medium
```

**Benefits**:
- Automated vulnerability detection
- Weekly security scans
- PR blocking on critical vulnerabilities

#### 1.4 Deployment Automation

**Create**: `.github/workflows/deploy.yml`

```yaml
name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
      - run: npm ci
      - run: npm run validate
      - run: npm test
      
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json"
      
      - name: Health Check
        run: |
          sleep 60
          curl -f https://bsm.lexdo.uk/api/health || exit 1
```

**Benefits**:
- Automated production deployment
- Health check validation
- Manual trigger option

---

### Priority 2: Important (Implement Soon)

#### 2.1 Branch Protection and PR Requirements

**GitHub Settings Configuration**:

```yaml
# .github/branch-protection.yml
branches:
  main:
    protection:
      required_status_checks:
        strict: true
        checks:
          - validate
          - lint
          - test
          - security/dependency-check
          - codeql
      required_pull_request_reviews:
        required_approving_review_count: 1
        dismiss_stale_reviews: true
      enforce_admins: false
      required_linear_history: true
```

#### 2.2 Staging Environment

**Create**: `.github/workflows/deploy-staging.yml`

```yaml
name: Deploy Staging

on:
  push:
    branches: [develop]

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - run: npm run validate
      
      - name: Deploy to Staging
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_STAGING_SERVICE_ID: ${{ secrets.RENDER_STAGING_SERVICE_ID }}
        run: |
          curl -X POST "https://api.render.com/v1/services/${RENDER_STAGING_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}"
      
      - name: Run Smoke Tests
        run: npm run test:smoke
        env:
          API_URL: https://staging.bsm.lexdo.uk
```

#### 2.3 Automated Release Management

**Create**: `.github/workflows/release.yml`

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate Changelog
        id: changelog
        run: |
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s (%h)" > changelog.txt
      
      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body_path: changelog.txt
          draft: false
          prerelease: false
```

#### 2.4 Performance Testing

**Create**: `.github/workflows/performance.yml`

```yaml
name: Performance Test

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://www.lexdo.uk
            https://bsm.lexdo.uk/api/health
          uploadArtifacts: true
          temporaryPublicStorage: true
  
  load-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - run: npm install -g artillery
      - run: artillery run tests/load/api-test.yml
        env:
          API_URL: https://staging.bsm.lexdo.uk
```

---

### Priority 3: Nice to Have (Future Implementation)

#### 3.1 Docker Build and Push

```yaml
name: Docker

on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/lexbank/bsm:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

#### 3.2 Infrastructure as Code Validation

```yaml
name: IaC Validate

on: [pull_request]

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform init
        working-directory: ./infrastructure
      - run: terraform validate
        working-directory: ./infrastructure
      - run: terraform plan
        working-directory: ./infrastructure
```

#### 3.3 End-to-End Testing

```yaml
name: E2E Tests

on:
  schedule:
    - cron: '0 4 * * *'
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
      - run: npm ci
      - uses: cypress-io/github-action@v6
        with:
          start: npm start
          wait-on: 'http://localhost:3000/api/health'
          browser: chrome
        env:
          CYPRESS_BASE_URL: http://localhost:3000
```

---

## Implementation Roadmap

### Week 1-2: Foundation
- [ ] Set up ESLint and Prettier
- [ ] Create lint workflow
- [ ] Add pre-commit hooks (Husky)
- [ ] Document code style guide

### Week 3-4: Testing Infrastructure
- [ ] Add testing framework (Jest or Mocha)
- [ ] Write unit tests for critical paths
- [ ] Create test workflow
- [ ] Set up code coverage

### Week 5-6: Security & Quality
- [ ] Implement dependency scanning
- [ ] Add Snyk integration
- [ ] Configure branch protection
- [ ] Set up PR requirements

### Week 7-8: Deployment Automation
- [ ] Create staging environment
- [ ] Set up deployment workflow
- [ ] Implement health checks
- [ ] Document rollback procedure

### Week 9-10: Advanced Features
- [ ] Add performance testing
- [ ] Implement release automation
- [ ] Set up monitoring alerts
- [ ] Create runbooks

---

## Cost Considerations

### GitHub Actions Free Tier
- 2,000 minutes/month for private repos
- Unlimited for public repos

### Estimated Monthly Usage
- Validate: 100 runs × 1 min = 100 min
- Lint: 100 runs × 1 min = 100 min
- Test: 100 runs × 2 min = 200 min
- Security: 30 runs × 2 min = 60 min
- Deploy: 30 runs × 2 min = 60 min
- **Total**: ~520 minutes/month

**Verdict**: Well within free tier ✅

### External Services
- **Snyk**: Free for open source
- **Codecov**: Free for open source
- **Render**: Varies by usage
- **Lighthouse CI**: Free

---

## Monitoring and Alerting

### Workflow Status Notifications

**Recommended**: Slack/Discord integration

```yaml
- name: Notify on Failure
  if: failure()
  uses: 8398a7/action-slack@v3
  with:
    status: ${{ job.status }}
    text: 'CI Pipeline Failed'
    webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

### Dashboard Recommendations

1. **GitHub Actions Dashboard**: Built-in workflow monitoring
2. **Status Page**: Create public status page for uptime
3. **Grafana**: For detailed metrics and logs

---

## Security Best Practices

### Secrets Management

✅ **Use GitHub Secrets for**:
- API keys
- Deployment tokens
- Service credentials
- Webhook URLs

❌ **Never commit**:
- API keys
- Passwords
- Private keys
- Environment files

### Environment Protection

**Configure GitHub Environments**:
- `production`: Requires manual approval
- `staging`: Auto-deploy on develop
- `development`: Local only

---

## Rollback Strategy

### Automated Rollback

```yaml
- name: Rollback on Failure
  if: failure()
  env:
    RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
    RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
  run: |
    # Get previous successful deploy
    PREVIOUS_DEPLOY=$(curl -s "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
      -H "Authorization: Bearer ${RENDER_API_KEY}" | \
      jq -r '.[] | select(.status=="live") | .id' | head -1)
    
    # Rollback
    curl -X POST "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${PREVIOUS_DEPLOY}/rollback" \
      -H "Authorization: Bearer ${RENDER_API_KEY}"
```

### Manual Rollback

```bash
# Revert to previous commit
git revert HEAD
git push origin main

# Or rollback to specific tag
git checkout v1.2.3
git tag -f v1.2.4
git push --tags --force
```

---

## Metrics and KPIs

### Pipeline Health Metrics

Track these metrics:
- **Build Success Rate**: Target > 95%
- **Average Build Time**: Target < 5 minutes
- **Deployment Frequency**: Current state vs. target
- **Mean Time to Recovery**: Target < 1 hour
- **Change Failure Rate**: Target < 5%

### Code Quality Metrics

- **Test Coverage**: Target > 80%
- **Linting Pass Rate**: Target 100%
- **Security Vulnerabilities**: Target 0 critical/high
- **Code Review Time**: Target < 24 hours

---

## Conclusion

Implementing these CI/CD enhancements will significantly improve:

✅ **Code Quality**: Automated linting and testing  
✅ **Security**: Continuous vulnerability scanning  
✅ **Reliability**: Automated deployment with health checks  
✅ **Velocity**: Faster, safer releases  
✅ **Confidence**: Comprehensive testing before production  

### Next Steps

1. Review and prioritize recommendations
2. Assign implementation tasks
3. Set up necessary external services (Snyk, Codecov)
4. Configure GitHub secrets
5. Begin with Priority 1 items

---

**Document Owner**: BSM Autonomous Architect  
**Review Cycle**: Quarterly  
**Last Updated**: 2026-02-06
