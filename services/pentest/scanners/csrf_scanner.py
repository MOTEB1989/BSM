"""CSRF Scanner - Detects Cross-Site Request Forgery vulnerabilities"""
import asyncio
from typing import Dict, List, Optional
import httpx
import structlog
from bs4 import BeautifulSoup

logger = structlog.get_logger()

class CSRFScanner:
    """Cross-Site Request Forgery vulnerability scanner"""
    
    def __init__(self):
        self.client = httpx.AsyncClient(timeout=30.0, follow_redirects=True)
    
    async def scan(self, target_url: str, auth_token: Optional[str] = None) -> List[Dict]:
        """Scan for CSRF vulnerabilities"""
        vulnerabilities = []
        try:
            logger.info("csrf_scan_start", target=target_url)
            headers = {"User-Agent": "BSU-PentestAgent/1.0"}
            if auth_token:
                headers["Authorization"] = f"Bearer {auth_token}"
            
            response = await self.client.get(target_url, headers=headers)
            soup = BeautifulSoup(response.text, 'html.parser')
            
            # Check forms for CSRF tokens
            forms = soup.find_all('form', method=['post', 'POST'])
            for form in forms:
                has_csrf_token = False
                inputs = form.find_all('input')
                
                for inp in inputs:
                    name = inp.get('name', '').lower()
                    if any(token in name for token in ['csrf', 'token', '_token', 'authenticity']):
                        has_csrf_token = True
                        break
                
                if not has_csrf_token and form.get('action'):
                    vulnerabilities.append({
                        "type": "csrf",
                        "name": "Cross-Site Request Forgery (CSRF)",
                        "description": f"Form without CSRF protection detected",
                        "severity": "medium",
                        "cvss_score": 6.5,
                        "url": target_url,
                        "method": "POST",
                        "form_action": form.get('action', ''),
                        "evidence": "No CSRF token found in form",
                        "solution": "Implement CSRF tokens for all state-changing operations",
                        "reference": "https://owasp.org/www-community/attacks/csrf",
                        "cwe_id": "CWE-352",
                        "remediation": [
                            "Implement anti-CSRF tokens",
                            "Use SameSite cookie attribute",
                            "Verify Origin/Referer headers",
                            "Require re-authentication for sensitive actions",
                            "Use framework CSRF protection"
                        ]
                    })
            
            logger.info("csrf_scan_complete", vulnerabilities_found=len(vulnerabilities))
        except Exception as e:
            logger.error("csrf_scan_failed", error=str(e))
        finally:
            await self.client.aclose()
        
        return vulnerabilities
