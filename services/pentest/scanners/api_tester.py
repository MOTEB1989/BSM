"""API Security Tester - Tests API endpoints with attack payloads"""
import asyncio
from typing import Dict, List, Optional
import httpx
import structlog
import json

logger = structlog.get_logger()

class APITester:
    """API endpoint security tester"""
    
    def __init__(self):
        self.client = httpx.AsyncClient(timeout=30.0)
    
    async def test_endpoints(
        self, 
        endpoints: List[str], 
        auth_token: Optional[str] = None,
        auth_type: str = "bearer"
    ) -> List[Dict]:
        """Test multiple API endpoints for vulnerabilities"""
        vulnerabilities = []
        
        for endpoint in endpoints:
            vulns = await self._test_endpoint(endpoint, auth_token, auth_type)
            vulnerabilities.extend(vulns)
        
        return vulnerabilities
    
    async def _test_endpoint(
        self, 
        endpoint: str, 
        auth_token: Optional[str],
        auth_type: str
    ) -> List[Dict]:
        """Test a single API endpoint"""
        vulnerabilities = []
        
        try:
            headers = {"User-Agent": "BSU-PentestAgent/1.0"}
            if auth_token:
                if auth_type == "bearer":
                    headers["Authorization"] = f"Bearer {auth_token}"
                elif auth_type == "basic":
                    headers["Authorization"] = f"Basic {auth_token}"
            
            # Test authentication bypass
            response_no_auth = await self.client.get(endpoint)
            if response_no_auth.status_code == 200:
                vulnerabilities.append({
                    "type": "api_auth_bypass",
                    "name": "Missing API Authentication",
                    "description": "API endpoint accessible without authentication",
                    "severity": "high",
                    "cvss_score": 7.5,
                    "url": endpoint,
                    "method": "GET",
                    "evidence": f"Endpoint returned 200 OK without authentication",
                    "solution": "Implement proper authentication and authorization",
                    "reference": "https://owasp.org/API-Security/editions/2023/en/0xa2-broken-authentication/",
                    "remediation": [
                        "Implement authentication for all API endpoints",
                        "Use OAuth 2.0 or JWT tokens",
                        "Implement rate limiting",
                        "Use API keys with proper rotation"
                    ]
                })
            
            # Test rate limiting
            responses = []
            for i in range(10):
                resp = await self.client.get(endpoint, headers=headers)
                responses.append(resp.status_code)
            
            if all(status == 200 for status in responses):
                vulnerabilities.append({
                    "type": "api_no_rate_limit",
                    "name": "Missing Rate Limiting",
                    "description": "API endpoint lacks rate limiting",
                    "severity": "medium",
                    "cvss_score": 5.3,
                    "url": endpoint,
                    "method": "GET",
                    "evidence": "10 consecutive requests succeeded without rate limiting",
                    "solution": "Implement rate limiting to prevent abuse",
                    "reference": "https://owasp.org/API-Security/editions/2023/en/0xa4-unrestricted-resource-consumption/",
                    "remediation": [
                        "Implement rate limiting per IP/user",
                        "Use tools like Redis for distributed rate limiting",
                        "Return 429 Too Many Requests when limit exceeded"
                    ]
                })
            
        except Exception as e:
            logger.error("api_test_failed", endpoint=endpoint, error=str(e))
        
        return vulnerabilities
