"""
OWASP ZAP Scanner Integration
Comprehensive security scanning using OWASP ZAP
"""

import asyncio
import logging
from typing import Dict, List, Optional
from zapv2 import ZAPv2
import structlog

logger = structlog.get_logger()


class ZAPScanner:
    """OWASP ZAP Scanner for comprehensive security testing"""
    
    def __init__(self, zap_proxy: str, api_key: str):
        self.zap_proxy = zap_proxy
        self.api_key = api_key
        self.zap: Optional[ZAPv2] = None
    
    async def start(self):
        """Initialize ZAP connection"""
        try:
            proxy_url = self.zap_proxy.replace("http://", "").replace("https://", "")
            host, port = proxy_url.split(":")
            
            self.zap = ZAPv2(
                apikey=self.api_key,
                proxies={
                    'http': self.zap_proxy,
                    'https': self.zap_proxy
                }
            )
            
            logger.info("zap_initialized", proxy=self.zap_proxy)
        except Exception as e:
            logger.error("zap_init_failed", error=str(e))
            raise
    
    async def stop(self):
        """Cleanup ZAP resources"""
        if self.zap:
            try:
                self.zap.core.shutdown()
                logger.info("zap_shutdown")
            except Exception as e:
                logger.warning("zap_shutdown_error", error=str(e))
    
    async def scan(
        self,
        target_url: str,
        auth_token: Optional[str] = None,
        max_depth: int = 3
    ) -> List[Dict]:
        """
        Perform comprehensive ZAP scan
        
        Returns list of vulnerabilities with CVSS scores
        """
        vulnerabilities = []
        
        try:
            logger.info("zap_scan_start", target=target_url)
            
            # Access the target
            self.zap.urlopen(target_url)
            await asyncio.sleep(2)
            
            # Spider scan
            logger.info("zap_spider_start")
            scan_id = self.zap.spider.scan(target_url, maxchildren=max_depth)
            
            # Wait for spider to complete
            while int(self.zap.spider.status(scan_id)) < 100:
                await asyncio.sleep(2)
            
            logger.info("zap_spider_complete")
            
            # Active scan
            logger.info("zap_active_scan_start")
            scan_id = self.zap.ascan.scan(target_url)
            
            # Wait for active scan to complete
            while int(self.zap.ascan.status(scan_id)) < 100:
                await asyncio.sleep(5)
            
            logger.info("zap_active_scan_complete")
            
            # Get alerts
            alerts = self.zap.core.alerts(baseurl=target_url)
            
            for alert in alerts:
                vulnerability = self._parse_zap_alert(alert)
                vulnerabilities.append(vulnerability)
            
            logger.info(
                "zap_scan_complete",
                vulnerabilities_found=len(vulnerabilities)
            )
            
        except Exception as e:
            logger.error("zap_scan_failed", error=str(e))
        
        return vulnerabilities
    
    def _parse_zap_alert(self, alert: Dict) -> Dict:
        """Parse ZAP alert into standardized vulnerability format"""
        
        # Map ZAP risk to severity
        risk_map = {
            "High": "high",
            "Medium": "medium",
            "Low": "low",
            "Informational": "info"
        }
        
        # Calculate CVSS score based on risk
        cvss_map = {
            "High": 8.5,
            "Medium": 5.5,
            "Low": 3.0,
            "Informational": 0.0
        }
        
        risk = alert.get("risk", "Low")
        
        return {
            "type": "zap",
            "name": alert.get("alert", "Unknown"),
            "description": alert.get("description", ""),
            "severity": risk_map.get(risk, "info"),
            "cvss_score": cvss_map.get(risk, 0.0),
            "url": alert.get("url", ""),
            "method": alert.get("method", ""),
            "parameter": alert.get("param", ""),
            "evidence": alert.get("evidence", ""),
            "solution": alert.get("solution", ""),
            "reference": alert.get("reference", ""),
            "cwe_id": alert.get("cweid", ""),
            "wasc_id": alert.get("wascid", ""),
            "confidence": alert.get("confidence", ""),
            "attack": alert.get("attack", ""),
            "other": alert.get("other", "")
        }
