"""Notification service for Slack and Email alerts"""
from typing import List, Dict, Optional
import structlog
from slack_sdk.webhook import WebhookClient
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from config import settings

logger = structlog.get_logger()

class Notifier:
    """Send notifications via Slack and Email"""
    
    async def send_critical_alert(self, scan_id: str, vulnerabilities: List[Dict]):
        """Send alert for critical vulnerabilities"""
        message = self._format_critical_message(scan_id, vulnerabilities)
        
        # Send to Slack
        if settings.SLACK_WEBHOOK_URL:
            await self._send_slack(message)
        
        # Send to Email
        if settings.EMAIL_SMTP_HOST and settings.EMAIL_TO:
            await self._send_email(
                subject=f"ðŸš¨ Critical Security Vulnerabilities Found - Scan {scan_id}",
                body=message
            )
    
    async def send_scan_summary(self, scan_id: str, scan_data: Dict):
        """Send scan completion summary"""
        message = self._format_summary_message(scan_id, scan_data)
        
        if settings.SLACK_WEBHOOK_URL:
            await self._send_slack(message, is_critical=False)
    
    def _format_critical_message(self, scan_id: str, vulnerabilities: List[Dict]) -> str:
        """Format critical vulnerability message"""
        vuln_list = "\n".join([
            f"â€¢ {v['name']} (CVSS: {v['cvss_score']}) - {v['url']}"
            for v in vulnerabilities[:5]  # Top 5
        ])
        
        return f"""
ðŸš¨ **CRITICAL SECURITY ALERT** ðŸš¨

Scan ID: {scan_id}
Critical Vulnerabilities Found: {len(vulnerabilities)}

Top Vulnerabilities:
{vuln_list}

Action Required: Review and remediate immediately.
View full report: /api/scan/{scan_id}/report
"""
    
    def _format_summary_message(self, scan_id: str, scan_data: Dict) -> str:
        """Format scan summary message"""
        severity = scan_data.get("severity_breakdown", {})
        total = len(scan_data.get("vulnerabilities", []))
        
        return f"""
ðŸ“Š Security Scan Complete

Scan ID: {scan_id}
Target: {scan_data.get('target_url', 'N/A')}
Status: {scan_data.get('status', 'N/A')}

Vulnerabilities Found: {total}
â€¢ Critical: {severity.get('critical', 0)}
â€¢ High: {severity.get('high', 0)}
â€¢ Medium: {severity.get('medium', 0)}
â€¢ Low: {severity.get('low', 0)}

View report: /api/scan/{scan_id}/report
"""
    
    async def _send_slack(self, message: str, is_critical: bool = True):
        """Send Slack notification"""
        try:
            webhook = WebhookClient(settings.SLACK_WEBHOOK_URL)
            color = "#FF0000" if is_critical else "#36a64f"
            
            webhook.send(
                text=message,
                attachments=[{
                    "color": color,
                    "text": message
                }]
            )
            logger.info("slack_notification_sent")
        except Exception as e:
            logger.error("slack_notification_failed", error=str(e))
    
    async def _send_email(self, subject: str, body: str):
        """Send email notification"""
        try:
            msg = MIMEMultipart()
            msg['From'] = settings.EMAIL_FROM
            msg['To'] = settings.EMAIL_TO
            msg['Subject'] = subject
            
            msg.attach(MIMEText(body, 'plain'))
            
            server = smtplib.SMTP(settings.EMAIL_SMTP_HOST, settings.EMAIL_SMTP_PORT)
            server.starttls()
            
            if settings.EMAIL_USERNAME and settings.EMAIL_PASSWORD:
                server.login(settings.EMAIL_USERNAME, settings.EMAIL_PASSWORD)
            
            server.send_message(msg)
            server.quit()
            
            logger.info("email_notification_sent")
        except Exception as e:
            logger.error("email_notification_failed", error=str(e))
