"""MongoDB Client for storing scan results"""
from typing import Dict, List, Optional
from pymongo import MongoClient as PyMongoClient
from datetime import datetime
import structlog

logger = structlog.get_logger()

class MongoClient:
    """MongoDB database client"""
    
    def __init__(self, uri: str):
        self.uri = uri
        self.client: Optional[PyMongoClient] = None
        self.db = None
    
    async def connect(self):
        """Connect to MongoDB"""
        try:
            self.client = PyMongoClient(self.uri)
            self.db = self.client.get_database()
            logger.info("mongodb_connected", uri=self.uri)
        except Exception as e:
            logger.error("mongodb_connection_failed", error=str(e))
            raise
    
    async def close(self):
        """Close MongoDB connection"""
        if self.client:
            self.client.close()
            logger.info("mongodb_closed")
    
    async def store_scan(self, scan_data: Dict):
        """Store a new scan"""
        scan_data["created_at"] = datetime.utcnow()
        result = self.db.scans.insert_one(scan_data)
        return str(result.inserted_id)
    
    async def get_scan(self, scan_id: str) -> Optional[Dict]:
        """Get scan by ID"""
        return self.db.scans.find_one({"scan_id": scan_id})
    
    async def update_scan(self, scan_id: str, updates: Dict):
        """Update scan data"""
        updates["updated_at"] = datetime.utcnow()
        self.db.scans.update_one(
            {"scan_id": scan_id},
            {"$set": updates}
        )
    
    async def list_scans(self, limit: int = 50, skip: int = 0) -> List[Dict]:
        """List all scans"""
        cursor = self.db.scans.find().sort("created_at", -1).skip(skip).limit(limit)
        return list(cursor)
    
    async def get_security_score_history(self, days: int = 30) -> List[Dict]:
        """Get security score history for dashboard"""
        from datetime import timedelta
        
        since = datetime.utcnow() - timedelta(days=days)
        cursor = self.db.scans.find(
            {"created_at": {"$gte": since}, "status": "completed"}
        ).sort("created_at", 1)
        
        history = []
        for scan in cursor:
            total_vulns = len(scan.get("vulnerabilities", []))
            critical = scan.get("severity_breakdown", {}).get("critical", 0)
            high = scan.get("severity_breakdown", {}).get("high", 0)
            
            # Calculate security score (0-100, lower is worse)
            score = max(0, 100 - (critical * 20) - (high * 10) - (total_vulns * 2))
            
            history.append({
                "date": scan["created_at"],
                "score": score,
                "vulnerabilities": total_vulns,
                "critical": critical,
                "high": high
            })
        
        return history
