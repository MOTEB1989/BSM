"""Report Generator for penetration test results"""
from typing import Dict
import json
from jinja2 import Template
from datetime import datetime
import structlog

logger = structlog.get_logger()

class ReportGenerator:
    """Generate security reports in various formats"""
    
    async def generate(self, scan_data: Dict, format: str = "json") -> Dict:
        """Generate report in specified format"""
        if format == "json":
            return self._generate_json(scan_data)
        elif format == "html":
            return {"report": self._generate_html(scan_data), "content_type": "text/html"}
        elif format == "markdown":
            return {"report": self._generate_markdown(scan_data), "content_type": "text/markdown"}
        else:
            return self._generate_json(scan_data)
    
    def _generate_json(self, scan_data: Dict) -> Dict:
        """Generate JSON report"""
        return {
            "scan_id": scan_data["scan_id"],
            "target_url": scan_data["target_url"],
            "status": scan_data["status"],
            "created_at": str(scan_data.get("created_at", "")),
            "completed_at": str(scan_data.get("completed_at", "")),
            "vulnerabilities": scan_data.get("vulnerabilities", []),
            "severity_breakdown": scan_data.get("severity_breakdown", {}),
            "summary": self._generate_summary(scan_data)
        }
    
    def _generate_markdown(self, scan_data: Dict) -> str:
        """Generate Markdown report"""
        vulns = scan_data.get("vulnerabilities", [])
        severity = scan_data.get("severity_breakdown", {})
        
        md = f"""# Security Penetration Test Report

## Scan Information
- **Scan ID**: {scan_data['scan_id']}
- **Target**: {scan_data['target_url']}
- **Status**: {scan_data['status']}
- **Date**: {scan_data.get('created_at', 'N/A')}

## Executive Summary
- **Total Vulnerabilities**: {len(vulns)}
- **Critical**: {severity.get('critical', 0)}
- **High**: {severity.get('high', 0)}
- **Medium**: {severity.get('medium', 0)}
- **Low**: {severity.get('low', 0)}

## Vulnerabilities

"""
        for vuln in vulns:
            md += f"""### {vuln['name']} ({vuln['severity'].upper()})
- **CVSS Score**: {vuln['cvss_score']}
- **URL**: {vuln['url']}
- **Description**: {vuln['description']}
- **Solution**: {vuln['solution']}
- **Reference**: {vuln.get('reference', 'N/A')}

#### Remediation Steps
"""
            for step in vuln.get('remediation', []):
                md += f"- {step}\n"
            
            md += "\n---\n\n"
        
        return md
    
    def _generate_html(self, scan_data: Dict) -> str:
        """Generate HTML report"""
        template = Template("""
<!DOCTYPE html>
<html>
<head>
    <title>Security Scan Report - {{ scan_id }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .header { background: #2c3e50; color: white; padding: 20px; }
        .summary { background: #ecf0f1; padding: 20px; margin: 20px 0; }
        .vuln { border: 1px solid #ddd; padding: 15px; margin: 10px 0; }
        .critical { border-left: 5px solid #e74c3c; }
        .high { border-left: 5px solid #e67e22; }
        .medium { border-left: 5px solid #f39c12; }
        .low { border-left: 5px solid #3498db; }
        .cvss { font-weight: bold; color: #e74c3c; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Security Penetration Test Report</h1>
        <p>Scan ID: {{ scan_id }}</p>
    </div>
    
    <div class="summary">
        <h2>Summary</h2>
        <p><strong>Target:</strong> {{ target_url }}</p>
        <p><strong>Date:</strong> {{ created_at }}</p>
        <p><strong>Total Vulnerabilities:</strong> {{ total_vulns }}</p>
        <ul>
            <li>Critical: {{ severity.critical }}</li>
            <li>High: {{ severity.high }}</li>
            <li>Medium: {{ severity.medium }}</li>
            <li>Low: {{ severity.low }}</li>
        </ul>
    </div>
    
    <h2>Vulnerabilities</h2>
    {% for vuln in vulnerabilities %}
    <div class="vuln {{ vuln.severity }}">
        <h3>{{ vuln.name }} <span class="cvss">(CVSS: {{ vuln.cvss_score }})</span></h3>
        <p><strong>Severity:</strong> {{ vuln.severity|upper }}</p>
        <p><strong>URL:</strong> {{ vuln.url }}</p>
        <p><strong>Description:</strong> {{ vuln.description }}</p>
        <p><strong>Solution:</strong> {{ vuln.solution }}</p>
    </div>
    {% endfor %}
</body>
</html>
""")
        
        return template.render(
            scan_id=scan_data['scan_id'],
            target_url=scan_data['target_url'],
            created_at=scan_data.get('created_at', 'N/A'),
            total_vulns=len(scan_data.get('vulnerabilities', [])),
            severity=scan_data.get('severity_breakdown', {}),
            vulnerabilities=scan_data.get('vulnerabilities', [])
        )
    
    def _generate_summary(self, scan_data: Dict) -> Dict:
        """Generate executive summary"""
        vulns = scan_data.get("vulnerabilities", [])
        severity = scan_data.get("severity_breakdown", {})
        
        critical_count = severity.get('critical', 0)
        high_count = severity.get('high', 0)
        
        if critical_count > 0:
            risk_level = "CRITICAL"
            recommendation = "Immediate action required. Do not deploy to production."
        elif high_count > 5:
            risk_level = "HIGH"
            recommendation = "Address high-severity issues before deployment."
        elif high_count > 0:
            risk_level = "MEDIUM"
            recommendation = "Review and plan remediation for identified issues."
        else:
            risk_level = "LOW"
            recommendation = "Continue monitoring and address remaining issues."
        
        return {
            "risk_level": risk_level,
            "recommendation": recommendation,
            "total_vulnerabilities": len(vulns),
            "severity_breakdown": severity
        }
