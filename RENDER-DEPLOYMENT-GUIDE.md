# Render.com Deployment Guide

## Overview

This guide explains the Render.com deployment configuration for the BSM (Business Service Management) platform.

## Configuration Details

The `render.yaml` file has been updated with the production configuration exported from Render.com.

### Service Configuration

- **Service Name**: `SR.BSM`
- **Type**: Web Service
- **Runtime**: Node.js
- **Region**: Virginia
- **Repository**: https://github.com/LexBANK/BSM

### Build & Deploy Commands

- **Build Command**: `npm ci` - Clean install of dependencies
- **Pre-Deploy Command**: `npm install` - Ensures all dependencies are installed before deployment
- **Start Command**: `npm start` - Starts the Node.js server (runs `node src/server.js`)

### Environment Variables

The following environment variables must be configured in the Render dashboard:

#### Required Variables

1. **NODE_ENV**: Set to `production` for production deployments
2. **ADMIN_TOKEN**: Admin authentication token (minimum 16 characters, cannot be `change-me`)
3. **OPENAI_BSM_KEY** or **OPENAI_API_KEY**: OpenAI API key for AI functionality
4. **CORS_ORIGINS**: Comma-separated list of allowed origins for CORS

#### Optional Variables

5. **PERPLEXITY_KEY**: Perplexity AI API key (for search functionality)
6. **KIMI_API_KEY**: Moonshot AI (Kimi) API key (for long-context handling)
7. **ANTHROPIC_API_KEY**: Anthropic (Claude) API key
8. **GITHUB_TOKEN**: GitHub personal access token (for GitHub integration)
9. **RENDER_DEPLOY_HOOK**: Deployment webhook URL (auto-generated by Render)

**Note**: All environment variables have `sync: false`, meaning they must be set manually in the Render dashboard and are not synced from the repository.

### Custom Domains

The service is configured with the following custom domains:

1. **www.corehub.nexus** - Primary web interface
2. **corehub.nexus** - Root domain
3. **lexprim.com** - Alternative domain
4. **www.lexprim.com** - WWW subdomain

### Auto-Deploy Settings

- **Auto-Deploy**: `off` - Manual deployment approval required
  - This is intentional to prevent automatic deployments and allows for manual review and approval before each deployment

## Security Considerations

### Environment Variables

- Never commit sensitive data to the repository
- All API keys and secrets must be set in the Render dashboard
- The `sync: false` setting ensures variables are not synced from the repository
- Use strong, unique values for all tokens and API keys

### CORS Configuration

Ensure `CORS_ORIGINS` includes all legitimate frontend domains:
```
https://www.corehub.nexus,https://corehub.nexus,https://lexprim.com,https://www.lexprim.com,https://lexdo.uk,https://www.lexdo.uk
```

### Admin Access

- Set a strong `ADMIN_TOKEN` (minimum 16 characters)
- Never use default values like `change-me` in production
- The server will refuse to start if an insecure admin token is detected in production

## Deployment Process

1. Push code changes to the repository
2. Navigate to Render dashboard
3. Manually trigger deployment (auto-deploy is off)
4. Monitor deployment logs for errors
5. Verify the deployment at the custom domains

## Health Checks

The service includes built-in health check endpoints:

- `GET /health` - Basic health check
- `GET /api/health` - API health check
- `GET /api/health/detailed` - Comprehensive health check

Render automatically monitors these endpoints to ensure service availability.

## Troubleshooting

### Common Issues

1. **Environment variables not set**: Check the Render dashboard and ensure all required variables are configured
2. **Domain not accessible**: Verify DNS configuration and SSL certificates in Render
3. **Build failures**: Check build logs in Render dashboard for missing dependencies or configuration errors
4. **Server startup failures**: Review the logs for missing required environment variables

### Logs

Access logs through:
- Render dashboard > Service > Logs
- Use structured logging with Pino for better debugging

## References

- [Render.com Documentation](https://render.com/docs)
- [BSM Repository](https://github.com/LexBANK/BSM)
- [Environment Variables](.env.example) - Template for local development

## Support

For deployment issues:
1. Check this guide first
2. Review Render documentation
3. Check service logs in Render dashboard
4. Contact the development team

---

**Last Updated**: 2026-02-20
**Configuration Version**: 1.0
