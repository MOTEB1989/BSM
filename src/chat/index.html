<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BSM - Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</title>
    <meta name="description" content="Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù€ BSM/LexBANK - 9 Ù†Ù…Ø§Ø°Ø¬ AI Ùˆ13 ÙˆÙƒÙŠÙ„ Ø°ÙƒÙŠ">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¦</text></svg>">
    <script src="/shared/config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body{font-family:'Tajawal',sans-serif;background:linear-gradient(135deg,#0a0e27 0%,#1a1f3a 50%,#0a0e27 100%)}
        .glass{background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.1)}
        .agent-card{transition:all 0.3s;cursor:pointer}
        .agent-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px -10px rgba(59,130,246,0.5)}
        .agent-card.selected{background:rgba(59,130,246,0.2);border-color:#3b82f6}
        .message-bubble{animation:slideIn 0.3s}
        @keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .typing-indicator span{animation:blink 1.4s infinite}
        @keyframes blink{0%,60%,100%{opacity:1}30%{opacity:0.3}}
    </style>
</head>
<body class="min-h-screen text-white">
    <div id="app" class="flex flex-col h-screen">
        <header class="glass border-b border-white/10">
            <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">ğŸ¦</div>
                    <div>
                        <h1 class="text-lg font-bold" id="app-title">BSM - Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø°ÙƒÙŠ</h1>
                        <p class="text-xs text-gray-400">Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-2 px-3 py-1 bg-black/20 rounded-lg">
                        <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500"></div>
                        <span id="status-text" class="text-xs">ØºÙŠØ± Ù…ØªØµÙ„</span>
                    </div>
                    <button onclick="app.toggleLang()" class="px-3 py-1 bg-black/20 rounded-lg text-xs">EN</button>
                    <button onclick="app.clear()" class="px-3 py-1 bg-black/20 rounded-lg">ğŸ—‘ï¸</button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden">
            <div class="max-w-7xl mx-auto h-full flex gap-4 p-4">
                <aside class="w-80 glass rounded-2xl p-4 overflow-y-auto">
                    <h2 class="text-sm font-bold mb-4">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙƒÙŠÙ„</h2>
                    <div id="agents-list" class="space-y-2"></div>
                </aside>

                <div class="flex-1 flex flex-col">
                    <div id="messages" class="flex-1 overflow-y-auto space-y-4 mb-4">
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">ğŸ¤–</div>
                            <h2 class="text-2xl font-bold mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2>
                            <p class="text-gray-400">Ø§Ø®ØªØ± ÙˆÙƒÙŠÙ„Ø§Ù‹ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-4">
                        <div class="flex gap-3">
                            <input type="text" id="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." class="flex-1 bg-black/30 border border-white/10 rounded-xl px-4 py-3" onkeypress="if(event.key==='Enter')app.send()"/>
                            <button id="btn" onclick="app.send()" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl font-bold">Ø¥Ø±Ø³Ø§Ù„</button>
                        </div>
                        <div class="mt-2 text-xs text-gray-400" id="selected">Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± ÙˆÙƒÙŠÙ„</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const app={
            cfg:window.BSM_CONFIG,
            api:window.API_BASE||'https://sr-bsm.onrender.com',
            lang:'ar',
            agent:null,
            history:[],

            init(){
                console.log('ğŸš€ BSM Unified Platform');
                console.log('ğŸ“¡ API:',this.api);
                this.loadAgents();
                this.checkHealth();
            },

            loadAgents(){
                const list=document.getElementById('agents-list');
                Object.values(this.cfg.agents).forEach(a=>{
                    const div=document.createElement('div');
                    div.className='agent-card glass rounded-xl p-3';
                    div.innerHTML=`<div class="flex gap-3"><div class="text-2xl">${a.icon}</div><div class="flex-1"><h3 class="font-bold text-sm">${a.name[this.lang]}</h3><p class="text-xs text-gray-400">${a.description[this.lang]}</p></div></div>`;
                    div.onclick=()=>this.selectAgent(a);
                    list.appendChild(div);
                });
            },

            selectAgent(a){
                this.agent=a;
                document.querySelectorAll('.agent-card').forEach(c=>c.classList.remove('selected'));
                event.target.closest('.agent-card').classList.add('selected');
                document.getElementById('selected').textContent=`Ø§Ù„ÙˆÙƒÙŠÙ„: ${a.name[this.lang]}`;
            },

            async send(){
                const input=document.getElementById('input');
                const msg=input.value.trim();
                if(!msg||!this.agent){alert('Ø§Ø®ØªØ± ÙˆÙƒÙŠÙ„Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹');return;}
                input.value='';
                this.addMsg(msg,'user');
                this.showTyping();
                document.getElementById('btn').disabled=true;

                try{
                    const history=this.history
                        .filter(h=>h.type==='user'||h.type==='assistant')
                        .map(h=>({role:h.type==='user'?'user':'assistant',content:h.content}));
                    const res=await fetch(`${this.api}${this.agent.endpoint}`,{
                        method:'POST',
                        headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({agentId:this.agent.id,message:msg,language:this.lang,history})
                    });
                    if(!res.ok)throw new Error(`HTTP ${res.status}`);
                    const data=await res.json();
                    const reply=data?.reply||data?.response||data?.message||'Ø®Ø·Ø£';
                    this.hideTyping();
                    this.addMsg(reply,'assistant');
                }catch(e){
                    this.hideTyping();
                    this.addMsg(`Ø®Ø·Ø£: ${e.message}`,'error');
                }finally{
                    document.getElementById('btn').disabled=false;
                }
            },

            addMsg(content,type){
                const div=document.createElement('div');
                div.className='message-bubble';
                if(type==='user'){
                    div.innerHTML=`<div class="flex justify-end"><div class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl px-4 py-3 max-w-2xl"><p>${this.esc(content)}</p></div></div>`;
                }else if(type==='error'){
                    div.innerHTML=`<div class="flex justify-start"><div class="bg-red-500/20 rounded-2xl px-4 py-3 max-w-2xl"><p class="text-red-300">${this.esc(content)}</p></div></div>`;
                }else{
                    const html=marked.parse(content);
                    div.innerHTML=`<div class="flex justify-start"><div class="glass rounded-2xl px-4 py-3 max-w-2xl">${html}</div></div>`;
                }
                document.getElementById('messages').appendChild(div);
                div.scrollIntoView({behavior:'smooth'});
                this.history.push({content,type,ts:Date.now()});
                localStorage.setItem('bsm_history',JSON.stringify(this.history));
            },

            showTyping(){
                const div=document.createElement('div');
                div.id='typing';
                div.innerHTML='<div class="flex justify-start"><div class="glass rounded-2xl px-4 py-3"><div class="typing-indicator flex gap-1"><span class="w-2 h-2 bg-gray-400 rounded-full"></span><span class="w-2 h-2 bg-gray-400 rounded-full"></span><span class="w-2 h-2 bg-gray-400 rounded-full"></span></div></div></div>';
                document.getElementById('messages').appendChild(div);
            },

            hideTyping(){
                const t=document.getElementById('typing');
                if(t)t.remove();
            },

            async checkHealth(){
                try{
                    const res=await fetch(`${this.api}/health`,{signal:AbortSignal.timeout(5000)});
                    if(res.ok){
                        document.getElementById('status-dot').className='w-2 h-2 rounded-full bg-green-500';
                        document.getElementById('status-text').textContent='Ù…ØªØµÙ„';
                    }
                }catch(e){
                    document.getElementById('status-dot').className='w-2 h-2 rounded-full bg-red-500';
                    document.getElementById('status-text').textContent='ØºÙŠØ± Ù…ØªØµÙ„';
                }
                setTimeout(()=>this.checkHealth(),30000);
            },

            toggleLang(){
                this.lang=this.lang==='ar'?'en':'ar';
                const dir=this.lang==='ar'?'rtl':'ltr';
                document.documentElement.setAttribute('lang',this.lang);
                document.documentElement.setAttribute('dir',dir);
                document.getElementById('app-title').textContent=this.cfg.getText(this.lang).appName;
                document.getElementById('agents-list').innerHTML='';
                this.loadAgents();
            },

            clear(){
                if(confirm('Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')){
                    this.history=[];
                    localStorage.removeItem('bsm_history');
                    document.getElementById('messages').innerHTML='<div class="text-center py-12"><div class="text-6xl mb-4">ğŸ¤–</div><h2 class="text-2xl font-bold mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</h2><p class="text-gray-400">Ø§Ø®ØªØ± ÙˆÙƒÙŠÙ„Ø§Ù‹ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</p></div>';
                }
            },

            esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
        };

        document.addEventListener('DOMContentLoaded',()=>app.init());
    </script>
</body>
</html>
