name: ü§ñ BSU CI/CD - Build, Test & Deploy to Render

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  BUILD_DIR: 'dist'

jobs:
  # ==================== ŸÖÿ±ÿ≠ŸÑÿ© 1: ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ====================
  test:
    runs-on: ubuntu-latest
    name: üß™ Test AI Agents
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸàŸÉŸÑÿßÿ° ÿßŸÑÿ¨ÿØÿØ
      - name: Test CodeReviewAgent
        env:
          OPENAI_BSM_KEY: ${{ secrets.OPENAI_BSM_KEY }}
        run: |
          node --input-type=module -e "
          import { codeReviewAgent } from './src/agents/CodeReviewAgent.js';
          try {
            const r = await codeReviewAgent.review({
              prNumber: 999,
              files: [{filename: 'test.js', changes: 10}],
              diff: 'console.log(\"test\")',
              author: 'test'
            });
            console.log('‚úÖ CodeReviewAgent:', r.score ? 'Working' : 'Failed');
            process.exit(0);
          } catch (e) {
            console.error('‚ùå CodeReviewAgent:', e.message);
            process.exit(1);
          }
          "

      - name: Test SecurityAgent
        env:
          PERPLEXITY_KEY: ${{ secrets.PERPLEXITY_KEY }}
        run: |
          node --input-type=module -e "
          import { scanForCVEs } from './src/agents/securityScanner.js';
          try {
            const r = await scanForCVEs([{name: 'lodash', version: '4.17.0'}]);
            console.log('‚úÖ SecurityAgent: Working (' + r.vulnerabilities.length + ' CVEs found)');
            process.exit(0);
          } catch (e) {
            console.error('‚ùå SecurityAgent:', e.message);
            process.exit(1);
          }
          "

      - name: Run full test suite
        run: npm test --if-present

  # ==================== ŸÖÿ±ÿ≠ŸÑÿ© 2: ÿßŸÑÿ®ŸÜÿßÿ° ====================
  build:
    runs-on: ubuntu-latest
    name: üì¶ Build Project
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build frontend (if exists)
        run: |
          if [ -f "src/chat/package.json" ]; then
            cd src/chat && npm ci && npm run build && cd ../..
          fi

      - name: Prepare deployment package
        run: |
          mkdir -p ${{ env.BUILD_DIR }}
          cp -r src ${{ env.BUILD_DIR }}/
          cp -r data ${{ env.BUILD_DIR }}/
          cp package*.json ${{ env.BUILD_DIR }}/
          cp README.md ${{ env.BUILD_DIR }}/
          echo "Build prepared at ${{ env.BUILD_DIR }}"

  # ==================== ŸÖÿ±ÿ≠ŸÑÿ© 3: ÿßŸÑŸÜÿ¥ÿ± ÿ•ŸÑŸâ Render ====================
  deploy-render:
    runs-on: ubuntu-latest
    name: üöÄ Deploy to Render
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ŸÜÿ¥ÿ± Render ÿπÿ®ÿ± Deploy Hook
      - name: Deploy to Render
        if: ${{ secrets.RENDER_DEPLOY_HOOK != '' }}
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "üöÄ Triggering Render deployment..."
          curl -X POST "$RENDER_DEPLOY_HOOK" \
            -H "Content-Type: application/json" \
            -d '{"branch":"main","commit":"'"$GITHUB_SHA"'"}' \
            || echo "‚ö†Ô∏è Render deploy hook failed"

      # ÿßŸÜÿ™ÿ∏ÿßÿ± Render (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
      - name: Wait for Render deployment
        if: ${{ secrets.RENDER_SERVICE_ID != '' && secrets.RENDER_API_KEY != '' }}
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "‚è≥ Waiting for Render deployment..."
          sleep 30

          # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ¥ÿ±
          status=$(curl -s -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys" | \
            jq -r '.[0].status')

          if [ "$status" = "live" ]; then
            echo "‚úÖ Render deployment successful"
          else
            echo "‚ö†Ô∏è Render status: $status"
          fi

  # ==================== ŸÖÿ±ÿ≠ŸÑÿ© 4: ÿ•ÿ¥ÿπÿßÿ± Slack ====================
  notify:
    runs-on: ubuntu-latest
    name: üì¢ Notify Slack
    needs: [test, build, deploy-render]
    if: always()
    steps:
      - name: Notify Slack - Success
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' && needs.deploy-render.result == 'success' }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload=$(jq -n \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg branch "$GITHUB_REF_NAME" \
            --arg commit "${GITHUB_SHA:0:7}" \
            --arg actor "$GITHUB_ACTOR" \
            --arg url "https://corehub.nexus" \
            '{
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "üöÄ BSU Nexus Deployed Successfully",
                    emoji: true
                  }
                },
                {
                  type: "section",
                  fields: [
                    { type: "mrkdwn", text: "*Repository:*\n\($repo)" },
                    { type: "mrkdwn", text: "*Branch:*\n\($branch)" },
                    { type: "mrkdwn", text: "*Commit:*\n\($commit)" },
                    { type: "mrkdwn", text: "*By:*\n\($actor)" }
                  ]
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "‚úÖ All AI Agents are online and ready\n<https://corehub.nexus|Open Dashboard>"
                  }
                }
              ]
            }')

          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "$SLACK_WEBHOOK"

      - name: Notify Slack - Failure
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' && (needs.test.result == 'failure' || needs.deploy-render.result == 'failure') }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload=$(jq -n \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg branch "$GITHUB_REF_NAME" \
            --arg run_url "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            '{
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "‚ùå BSU Nexus Deployment Failed",
                    emoji: true
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "Deployment failed for \($repo) on \($branch).\n<\($run_url)|View Logs>"
                  }
                }
              ]
            }')

          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "$SLACK_WEBHOOK"
