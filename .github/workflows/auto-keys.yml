name: "üîê Auto Key Management & Validation"

on:
  schedule:
    - cron: "0 0 * * 0" # Every Sunday at midnight UTC
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/config/**"
      - "src/agents/**"

jobs:
  validate-keys:
    name: "Validate All AI Keys"
    runs-on: ubuntu-latest
    outputs:
      openai_status: ${{ steps.check.outputs.openai }}
      anthropic_status: ${{ steps.check.outputs.anthropic }}
      perplexity_status: ${{ steps.check.outputs.perplexity }}
      google_status: ${{ steps.check.outputs.google }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Validate AI Keys
        id: check
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_BSM_KEY }}
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_KEY }}
          PERPLEXITY_KEY: ${{ secrets.PERPLEXITY_KEY }}
          GOOGLE_KEY: ${{ secrets.GOOGLE_AI_KEY }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');

          function requestStatus({ hostname, path, key, headers = {} }) {
            return new Promise((resolve) => {
              if (!key) {
                resolve(false);
                return;
              }

              const req = https.request(
                {
                  hostname,
                  path,
                  method: 'GET',
                  timeout: 8000,
                  headers: {
                    Authorization: `Bearer ${key}`,
                    ...headers
                  }
                },
                (res) => {
                  resolve(res.statusCode >= 200 && res.statusCode < 300);
                }
              );

              req.on('timeout', () => {
                req.destroy(new Error('timeout'));
              });
              req.on('error', () => resolve(false));
              req.end();
            });
          }

          const validators = {
            openai: (key) =>
              requestStatus({
                hostname: 'api.openai.com',
                path: '/v1/models',
                key
              }),

            perplexity: (key) =>
              requestStatus({
                hostname: 'api.perplexity.ai',
                path: '/models',
                key
              }),

            anthropic: async (key) =>
              Boolean(key && /^sk-ant-[A-Za-z0-9_-]{20,}$/.test(key)),

            google: async (key) =>
              Boolean(key && /^AIza[A-Za-z0-9_-]{20,}$/.test(key))
          };

          async function validateAll() {
            const results = {
              openai: false,
              anthropic: false,
              perplexity: false,
              google: false
            };

            const inputKeys = {
              openai: process.env.OPENAI_KEY,
              anthropic: process.env.ANTHROPIC_KEY,
              perplexity: process.env.PERPLEXITY_KEY,
              google: process.env.GOOGLE_KEY
            };

            for (const provider of Object.keys(results)) {
              if (!inputKeys[provider]) {
                console.log(`${provider}: ‚ùå (missing key)`);
                continue;
              }

              results[provider] = await validators[provider](inputKeys[provider]);
              console.log(`${provider}: ${results[provider] ? '‚úÖ' : '‚ùå'}`);
            }

            fs.appendFileSync(process.env.GITHUB_OUTPUT, `openai=${results.openai}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `anthropic=${results.anthropic}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `perplexity=${results.perplexity}\n`);
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `google=${results.google}\n`);

            fs.writeFileSync(
              'key-report.json',
              JSON.stringify(
                {
                  timestamp: new Date().toISOString(),
                  results,
                  summary: {
                    total: Object.keys(results).length,
                    active: Object.values(results).filter(Boolean).length,
                    failed: Object.values(results).filter((v) => !v).length
                  }
                },
                null,
                2
              )
            );

            const failed = Object.entries(results)
              .filter(([, ok]) => !ok)
              .map(([name]) => name);

            if (failed.length > 0) {
              console.error(`\n‚ùå Failed keys: ${failed.join(', ')}`);
              process.exit(1);
            }

            console.log('\n‚úÖ All keys validated successfully!');
          }

          validateAll().catch((error) => {
            console.error('Validation script crashed:', error.message);
            process.exit(1);
          });
          EOF

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: key-validation-report
          path: key-report.json

  update-dashboard:
    name: "Update Dashboard"
    needs: validate-keys
    runs-on: ubuntu-latest
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Key Status Dashboard
        run: |
          mkdir -p docs/status

          cat > docs/status/ai-keys.json << EOF
          {
            "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "status": {
              "openai": "${{ needs.validate-keys.outputs.openai_status }}",
              "anthropic": "${{ needs.validate-keys.outputs.anthropic_status }}",
              "perplexity": "${{ needs.validate-keys.outputs.perplexity_status }}",
              "google": "${{ needs.validate-keys.outputs.google_status }}"
            },
            "ui": {
              "openai": "${{ needs.validate-keys.outputs.openai_status == 'true' && '‚úÖ GPT-4 Ready' || 'üî¥ GPT-4 Offline' }}",
              "anthropic": "${{ needs.validate-keys.outputs.anthropic_status == 'true' && '‚úÖ Claude Ready' || 'üî¥ Claude Offline' }}",
              "perplexity": "${{ needs.validate-keys.outputs.perplexity_status == 'true' && '‚úÖ Perplexity Ready' || 'üî¥ Perplexity Offline' }}",
              "google": "${{ needs.validate-keys.outputs.google_status == 'true' && '‚úÖ Gemini Ready' || 'üî¥ Gemini Offline' }}"
            }
          }
          EOF

          git config user.name "ü§ñ BSU Key Manager"
          git config user.email "keys@corehub.nexus"

          git add docs/status/ai-keys.json
          git diff --cached --quiet && echo "No changes" && exit 0

          git commit -m "üîê Auto-update: AI Key Status [$(date +%Y-%m-%d)]"
          git push

  alert-failure:
    name: "Alert on Failure"
    needs: validate-keys
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Send Slack Alert
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "üö® BSU Nexus: AI Key Validation Failed!",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*AI Key Validation Failed*\n\n‚Ä¢ OpenAI: ${{ needs.validate-keys.outputs.openai_status == 'true' && '‚úÖ' || '‚ùå' }}\n‚Ä¢ Anthropic: ${{ needs.validate-keys.outputs.anthropic_status == 'true' && '‚úÖ' || '‚ùå' }}\n‚Ä¢ Perplexity: ${{ needs.validate-keys.outputs.perplexity_status == 'true' && '‚úÖ' || '‚ùå' }}\n‚Ä¢ Google: ${{ needs.validate-keys.outputs.google_status == 'true' && '‚úÖ' || '‚ùå' }}\n\n<https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® AI Key Validation Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Key Validation Results\n\n| Provider | Status |\n|----------|--------|\n| OpenAI | ${{ needs.validate-keys.outputs.openai_status == 'true' && '‚úÖ' || '‚ùå' }} |\n| Anthropic | ${{ needs.validate-keys.outputs.anthropic_status == 'true' && '‚úÖ' || '‚ùå' }} |\n| Perplexity | ${{ needs.validate-keys.outputs.perplexity_status == 'true' && '‚úÖ' || '‚ùå' }} |\n| Google | ${{ needs.validate-keys.outputs.google_status == 'true' && '‚úÖ' || '‚ùå' }} |\n\nPlease check the [Actions run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.",
              labels: ['urgent', 'keys', 'automation']
            });

  deploy-if-valid:
    name: "Deploy with Valid Keys"
    needs: validate-keys
    runs-on: ubuntu-latest
    if: needs.validate-keys.result == 'success'
    steps:
      - name: Deploy to Production
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "‚ùå Missing Render deployment secrets"
            exit 1
          fi

          echo "üöÄ Deploying with validated keys..."
          curl -fsS -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            "https://api.render.com/v1/services/$RENDER_SERVICE_ID/deploys"

          echo "‚úÖ Deployment triggered successfully!"
