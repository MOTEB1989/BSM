name: "\U0001F916 Unified CI / Test, Build & Deploy to Render"

on:
  push:
    branches: [main]
    paths:
      - 'src/**'
      - 'data/**'
      - 'package.json'
      - 'package-lock.json'
      - 'render.yaml'
      - '.github/workflows/unified-ci-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'data/**'
      - 'package.json'
      - 'package-lock.json'
      - 'render.yaml'
      - '.github/workflows/unified-ci-deploy.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  BUILD_DIR: 'dist'
  SMOKE_URL: 'https://corehub.nexus'

jobs:
  # ==================== Phase 1: Preflight Checks ====================
  preflight:
    runs-on: ubuntu-latest
    name: "\U0001F6EB Preflight Checks"
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: Verify project structure
        run: |
          echo "=== Project Structure ==="
          ls -la
          echo "=== Checking Agents ==="
          ls -la src/agents/ || echo "No agents directory"
          echo "=== Checking Config ==="
          ls -la src/config/ || echo "No config directory"
          echo "=== Checking Data Agents ==="
          ls -la data/agents/ || echo "No data/agents directory"

  # ==================== Phase 2: Test AI Agents ====================
  test-agents:
    runs-on: ubuntu-latest
    name: "\U0001F9EA Test AI Agents"
    needs: preflight
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      # Test CodeReviewAgent (requires OpenAI API key)
      - name: Test CodeReviewAgent
        env:
          OPENAI_BSM_KEY: ${{ secrets.OPENAI_BSM_KEY }}
        run: |
          node --input-type=module -e "
          import { codeReviewAgent } from './src/agents/CodeReviewAgent.js';
          try {
            const r = await codeReviewAgent.review({
              prNumber: 999,
              files: [{filename: 'test.js', changes: 10}],
              diff: 'console.log(\"test\")',
              author: 'ci-test'
            });
            console.log('CodeReviewAgent: Working (Score: ' + r.score + ')');
          } catch (e) {
            console.error('CodeReviewAgent failed:', e.message);
            process.exit(1);
          }
          "

      # Test SecurityScanner (requires Perplexity API key)
      - name: Test SecurityScanner
        env:
          PERPLEXITY_KEY: ${{ secrets.PERPLEXITY_KEY }}
        run: |
          node --input-type=module -e "
          import { scanForCVEs } from './src/agents/securityScanner.js';
          try {
            const r = await scanForCVEs([{name: 'lodash', version: '4.17.0'}]);
            console.log('SecurityScanner: Working (' + r.vulnerabilities.length + ' CVEs found)');
          } catch (e) {
            console.error('SecurityScanner failed:', e.message);
            process.exit(1);
          }
          "

      # Test PRMergeAgent (pure logic, no API key required)
      - name: Test PRMergeAgent
        run: |
          node --input-type=module -e "
          import { prMergeAgent } from './src/agents/PRMergeAgent.js';
          const result = prMergeAgent.evaluate(
            { prNumber: 999 },
            [
              { agentId: 'code-review-agent', score: 8 },
              { agentId: 'security-agent', summary: { critical: 0 } }
            ]
          );
          console.log('PRMergeAgent: ' + result.action);
          if (result.action !== 'approve') {
            console.error('Expected approve but got ' + result.action);
            process.exit(1);
          }
          "

      # Test IntegrityAgent (pure logic, no API key required)
      - name: Test IntegrityAgent
        run: |
          node --input-type=module -e "
          import { integrityAgent } from './src/agents/IntegrityAgent.js';
          const result = integrityAgent.check({ prs: [], issues: [] });
          console.log('IntegrityAgent: Health Score: ' + result.healthScore);
          if (result.healthScore !== 100) {
            console.error('Expected health score 100 for empty input');
            process.exit(1);
          }
          "

      - name: Run validation suite
        run: npm test

  # ==================== Phase 3: Build Project ====================
  build:
    runs-on: ubuntu-latest
    name: "\U0001F4E6 Build Project"
    needs: [preflight, test-agents]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Cache node_modules
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ env.NODE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ env.NODE_VERSION }}-
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci --prefer-offline

      - name: Cache frontend build
        uses: actions/cache@v4
        id: cache-frontend
        with:
          path: src/chat/dist
          key: frontend-${{ hashFiles('src/chat/**/*.js', 'src/chat/**/*.vue', 'src/chat/package-lock.json') }}

      - name: Build frontend (if exists)
        if: steps.cache-frontend.outputs.cache-hit != 'true'
        run: |
          if [ -f "src/chat/package.json" ]; then
            cd src/chat && npm ci && npm run build && cd ../..
          fi

      - name: Build main project
        run: npm run build --if-present || echo "No build script, skipping"

      - name: Verify build output
        run: |
          if [ -d "$BUILD_DIR" ]; then
            echo "Build directory $BUILD_DIR exists"
            ls -la "$BUILD_DIR" | head -20
          elif [ -d "build" ]; then
            echo "Build directory build/ exists"
            ls -la build | head -20
          else
            echo "No build directory (API-only project)"
          fi

  # ==================== Phase 4: Deploy to Render ====================
  deploy-render:
    runs-on: ubuntu-latest
    name: "\U0001F680 Deploy to Render"
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install Render CLI v2.7.1
        run: |
          curl -fsSL https://github.com/render-oss/cli/releases/download/v2.7.1/render_Linux_x86_64.tar.gz -o render-cli.tar.gz
          tar -xzf render-cli.tar.gz -C /usr/local/bin render
          rm render-cli.tar.gz
          render --version

      - name: Validate render.yaml blueprint
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
        if: ${{ secrets.RENDER_API_KEY != '' }}
        run: |
          echo "Validating render.yaml blueprint..."
          render blueprint validate --output json render.yaml
          echo "Blueprint validation passed"

      - name: Deploy via Render CLI
        if: ${{ secrets.RENDER_API_KEY != '' && secrets.RENDER_SERVICE_ID != '' }}
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Deploying via Render CLI..."
          render deploys create "$RENDER_SERVICE_ID" \
            --output json \
            --confirm
          echo "Deployment triggered via Render CLI"

      - name: Deploy via Deploy Hook (fallback)
        if: ${{ secrets.RENDER_API_KEY == '' && secrets.RENDER_DEPLOY_HOOK != '' }}
        env:
          RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}
        run: |
          echo "Triggering Render deployment via deploy hook (fallback)..."
          response=$(curl -s -X POST "$RENDER_DEPLOY_HOOK" \
            -H "Content-Type: application/json" \
            -d '{"branch":"main","commit":"'"$GITHUB_SHA"'","source":"github-actions"}')
          echo "Render response: $response"

      - name: Check deployment status
        if: ${{ secrets.RENDER_API_KEY != '' && secrets.RENDER_SERVICE_ID != '' }}
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Checking deployment status..."
          for i in {1..12}; do
            deploy_output=$(render deploys list "$RENDER_SERVICE_ID" \
              --output json 2>/dev/null || echo "[]")
            status=$(echo "$deploy_output" | jq -r '.[0].status // empty' 2>/dev/null)

            if [ -z "$status" ] || [ "$status" = "null" ]; then
              echo "Attempt $i/12 - No deployments found yet"
              sleep 15
              continue
            fi

            echo "Attempt $i/12 - Status: $status"

            if [ "$status" = "live" ]; then
              echo "Deployment is live!"
              exit 0
            fi

            if [ "$status" = "build_failed" ] || [ "$status" = "update_failed" ] || [ "$status" = "canceled" ]; then
              echo "Deployment failed with status: $status"
              exit 1
            fi

            sleep 15
          done

          echo "Deployment still in progress (may complete later)"

  # ==================== Phase 5: Smoke Test ====================
  smoke-test:
    runs-on: ubuntu-latest
    name: "\U0001F4A8 Smoke Test"
    needs: deploy-render
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: Smoke Test - corehub.nexus
        env:
          SMOKE_URL: ${{ env.SMOKE_URL }}
        run: |
          echo "Testing $SMOKE_URL ..."
          for i in {1..5}; do
            if curl -sSfL "$SMOKE_URL" -o /dev/null; then
              echo "$SMOKE_URL is reachable"
              exit 0
            fi
            echo "Retry $i/5..."
            sleep 10
          done
          echo "$SMOKE_URL not reachable after retries"
          exit 1

  # ==================== Phase 6: Slack Notification ====================
  notify:
    runs-on: ubuntu-latest
    name: "\U0001F4E2 Notify Slack"
    needs: smoke-test
    if: always()
    steps:
      - name: Notify Slack - Success
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' && needs.deploy-render.result == 'success' && needs.smoke-test.result == 'success' }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload=$(jq -n \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg branch "$GITHUB_REF_NAME" \
            --arg commit "${GITHUB_SHA:0:7}" \
            --arg actor "$GITHUB_ACTOR" \
            --arg url "https://corehub.nexus" \
            '{
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "BSU Nexus Deployed Successfully",
                    emoji: true
                  }
                },
                {
                  type: "section",
                  fields: [
                    { type: "mrkdwn", text: "*Repository:*\n\($repo)" },
                    { type: "mrkdwn", text: "*Branch:*\n\($branch)" },
                    { type: "mrkdwn", text: "*Commit:*\n\($commit)" },
                    { type: "mrkdwn", text: "*By:*\n\($actor)" }
                  ]
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "All AI Agents tested and deployed\n<\($url)|Open Dashboard>\nAgents: CodeReview, Security, PRMerge, Integrity"
                  }
                },
                {
                  type: "context",
                  elements: [
                    { type: "mrkdwn", text: "Automated deployment via GitHub Actions" }
                  ]
                }
              ]
            }')

          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "$SLACK_WEBHOOK"

      - name: Notify Slack - Failure
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' && (needs.test-agents.result == 'failure' || needs.deploy-render.result == 'failure' || needs.smoke-test.result == 'failure') }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Determine which step failed
          failed_step=""
          if [ "${{ needs.test-agents.result }}" == "failure" ]; then failed_step="AI Agents Tests"; fi
          if [ "${{ needs.deploy-render.result }}" == "failure" ]; then failed_step="Render Deployment"; fi
          if [ "${{ needs.smoke-test.result }}" == "failure" ]; then failed_step="Smoke Test"; fi

          payload=$(jq -n \
            --arg repo "$GITHUB_REPOSITORY" \
            --arg branch "$GITHUB_REF_NAME" \
            --arg run_url "$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            --arg failed "$failed_step" \
            '{
              blocks: [
                {
                  type: "header",
                  text: {
                    type: "plain_text",
                    text: "BSU Nexus Deployment Failed",
                    emoji: true
                  }
                },
                {
                  type: "section",
                  text: {
                    type: "mrkdwn",
                    text: "Deployment failed for \($repo) on \($branch).\n*Failed step:* \($failed)\n<\($run_url)|View Logs>"
                  }
                }
              ]
            }')

          curl -s -X POST -H 'Content-type: application/json' \
            --data "$payload" "$SLACK_WEBHOOK"
