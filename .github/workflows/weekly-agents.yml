name: Weekly Agents Audit

on:
  schedule:
    # Every Sunday at 06:00 UTC
    - cron: "0 6 * * 0"
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  weekly-audit:
    runs-on: ubuntu-latest
    env:
      GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
      KM_ENDPOINT: ${{ secrets.KM_ENDPOINT }}
      KM_TOKEN: ${{ secrets.KM_TOKEN }}
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Set up Node
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: 22

      - name: Install tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq
          npm install -g snyk || true

      - name: Make scripts executable
        run: chmod +x scripts/run_agents.sh

      - name: Run agents pipeline (strict)
        id: agents
        run: |
          set -euo pipefail
          ./scripts/run_agents.sh reports false
          echo "status=success" >> "$GITHUB_OUTPUT"

      - name: Upload report artifacts
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4
        if: always()
        with:
          name: weekly-audit-report
          path: reports/
          retention-days: 90

      - name: Open issue on failure
        if: failure()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const date = new Date().toISOString().slice(0, 10);
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Weekly Agents Audit Failed â€” ${date}`,
              body: [
                `The scheduled weekly agents audit failed on ${date}.`,
                '',
                '**Action required:** Review the workflow run for details.',
                '',
                `[View workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              ].join('\n'),
              labels: ['automation', 'audit-failure'],
            });
