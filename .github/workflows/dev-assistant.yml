name: AI Dev Assistant

on:
  push:
    branches: [main, develop]
    paths:
      - '**.js'
      - '**.ts'
      - '**.py'
      - 'src/**'
      - 'services/**'
  pull_request:
    branches: [main, develop]
    paths:
      - '**.js'
      - '**.ts'
      - '**.py'
      - 'src/**'
      - 'services/**'

concurrency:
  group: dev-assistant-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  analyze-and-assist:
    name: AI Development Assistant
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **.js
            **.ts
            **.py
            src/**
            services/**
      
      - name: Analyze changed code
        if: steps.changed-files.outputs.any_changed == 'true'
        env:
          OPENAI_BSU_KEY: ${{ secrets.OPENAI_BSU_KEY }}
        run: |
          echo "Analyzing changed files..."
          node --input-type=module -e "
          import { devAssistantAgent } from './src/agents/DevAssistantAgent.js';
          import fs from 'fs';
          
          const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
          console.log('Changed files:', changedFiles);
          
          async function analyzeFiles() {
            const results = [];
            for (const file of changedFiles) {
              if (!file.match(/\.(js|ts|py)$/)) continue;
              
              try {
                const code = fs.readFileSync(file, 'utf-8');
                const language = file.endsWith('.py') ? 'python' : 'javascript';
                
                console.log(\`\\nAnalyzing: \${file}\`);
                const smells = devAssistantAgent.detectCodeSmells(code, language);
                
                results.push({
                  file,
                  smellsCount: smells.length,
                  smells: smells.slice(0, 5) // Top 5 smells
                });
                
                if (smells.length > 0) {
                  console.log(\`  âš ï¸  Found \${smells.length} code smell(s)\`);
                  smells.slice(0, 3).forEach(smell => {
                    console.log(\`    - [\${smell.severity}] \${smell.type}: \${smell.message}\`);
                  });
                }
              } catch (error) {
                console.error(\`Error analyzing \${file}:\`, error.message);
              }
            }
            
            // Save results for next step
            fs.writeFileSync('analysis-results.json', JSON.stringify(results, null, 2));
            
            const totalSmells = results.reduce((sum, r) => sum + r.smellsCount, 0);
            console.log(\`\\nðŸ“Š Total code smells detected: \${totalSmells}\`);
          }
          
          analyzeFiles().catch(console.error);
          "
      
      - name: Generate missing tests
        if: steps.changed-files.outputs.any_changed == 'true' && github.event_name == 'push'
        env:
          OPENAI_BSU_KEY: ${{ secrets.OPENAI_BSU_KEY }}
        run: |
          echo "Checking for files without tests..."
          node --input-type=module -e "
          import { devAssistantAgent } from './src/agents/DevAssistantAgent.js';
          import fs from 'fs';
          import path from 'path';
          
          const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
          
          async function generateMissingTests() {
            for (const file of changedFiles) {
              if (!file.match(/\.(js|ts)$/) || file.includes('.test.') || file.includes('.spec.')) continue;
              
              const testFile = file.replace(/\.(js|ts)$/, '.test.js');
              if (fs.existsSync(testFile)) {
                console.log(\`âœ“ Test exists for \${file}\`);
                continue;
              }
              
              console.log(\`âš ï¸  Missing test for \${file}\`);
              console.log(\`   Suggested test file: \${testFile}\`);
            }
          }
          
          generateMissingTests().catch(console.error);
          "
      
      - name: Generate documentation suggestions
        if: steps.changed-files.outputs.any_changed == 'true' && github.event_name == 'pull_request'
        env:
          OPENAI_BSU_KEY: ${{ secrets.OPENAI_BSU_KEY }}
        run: |
          echo "Checking for missing documentation..."
          node --input-type=module -e "
          import { devAssistantAgent } from './src/agents/DevAssistantAgent.js';
          import fs from 'fs';
          
          const changedFiles = '${{ steps.changed-files.outputs.all_changed_files }}'.split(' ');
          
          async function checkDocumentation() {
            for (const file of changedFiles) {
              if (!file.match(/\.(js|ts)$/)) continue;
              
              try {
                const code = fs.readFileSync(file, 'utf-8');
                const functions = devAssistantAgent.extractFunctions(code, 'javascript');
                
                // Check for missing JSDoc
                const undocumented = functions.filter(fn => {
                  const fnCode = fn.code || '';
                  return !fnCode.includes('/**') && !fnCode.includes('//');
                });
                
                if (undocumented.length > 0) {
                  console.log(\`âš ï¸  \${file}: \${undocumented.length} function(s) missing documentation\`);
                  undocumented.slice(0, 3).forEach(fn => {
                    console.log(\`   - \${fn.name}()\`);
                  });
                }
              } catch (error) {
                console.error(\`Error checking \${file}:\`, error.message);
              }
            }
          }
          
          checkDocumentation().catch(console.error);
          "
      
      - name: Create PR comment with suggestions
        if: steps.changed-files.outputs.any_changed == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          OPENAI_BSU_KEY: ${{ secrets.OPENAI_BSU_KEY }}
        with:
          script: |
            const fs = require('fs');
            
            // Check if analysis results exist
            if (!fs.existsSync('analysis-results.json')) {
              console.log('No analysis results found');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync('analysis-results.json', 'utf-8'));
            const totalSmells = results.reduce((sum, r) => sum + r.smellsCount, 0);
            
            if (totalSmells === 0) {
              console.log('No issues found, skipping comment');
              return;
            }
            
            let body = '## ðŸ¤– AI Development Assistant Analysis\n\n';
            body += `Found **${totalSmells}** potential improvement(s) in the changed files:\n\n`;
            
            for (const result of results) {
              if (result.smellsCount === 0) continue;
              
              body += `### ðŸ“„ \`${result.file}\` (${result.smellsCount} issue(s))\n\n`;
              
              result.smells.forEach(smell => {
                const icon = smell.severity === 'high' ? 'ðŸ”´' : smell.severity === 'medium' ? 'ðŸŸ¡' : 'ðŸŸ¢';
                body += `${icon} **${smell.type}** (${smell.severity})\n`;
                body += `   ${smell.message}\n`;
                if (smell.loc) {
                  body += `   _Line ${smell.loc.start.line}_\n`;
                }
                body += '\n';
              });
            }
            
            body += '\n---\n';
            body += 'ðŸ’¡ **Tip**: Use the Dev Assistant API endpoints to automatically refactor and improve your code.\n';
            
            // Create or update comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('AI Development Assistant Analysis')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ¤– AI Development Assistant Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Code analysis completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Test coverage check completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documentation check completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š View detailed results in the workflow logs above" >> $GITHUB_STEP_SUMMARY
