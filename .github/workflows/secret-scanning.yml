name: Secret Scanning

# This workflow scans for leaked secrets in the codebase
# using Gitleaks and TruffleHog

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
    branches: 
      - main
      - develop
  schedule:
    # Run weekly on Sundays at midnight
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  # ============================================
  # Gitleaks - Fast Secret Scanning
  # ============================================
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write  # For uploading SARIF results
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for complete scan

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional
        continue-on-error: false  # Fail the build if secrets found

      - name: Upload Gitleaks results to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif
          category: gitleaks

  # ============================================
  # TruffleHog - Deep Secret Scanning
  # ============================================
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified --fail

  # ============================================
  # Git Secrets - Alternative Scanner
  # ============================================
  git-secrets:
    name: Git Secrets Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install git-secrets
        run: |
          git clone https://github.com/awslabs/git-secrets.git
          cd git-secrets
          sudo make install

      - name: Register AWS patterns
        run: |
          git secrets --register-aws --global

      - name: Add custom patterns
        run: |
          git secrets --add 'sk-[a-zA-Z0-9]{48}' --global
          git secrets --add 'ghp_[a-zA-Z0-9]{36}' --global
          git secrets --add 'AKIA[0-9A-Z]{16}' --global

      - name: Scan repository
        run: git secrets --scan-history

  # ============================================
  # Summary Report
  # ============================================
  summary:
    name: Generate Security Summary
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, git-secrets]
    if: always()
    permissions: {}
    
    steps:
      - name: Security Summary
        run: |
          echo "## ðŸ” Secret Scanning Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Gitleaks: ${{ needs.gitleaks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… TruffleHog: ${{ needs.trufflehog.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Git Secrets: ${{ needs.git-secrets.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "If any secrets were found:" >> $GITHUB_STEP_SUMMARY
          echo "1. Rotate the compromised credentials immediately" >> $GITHUB_STEP_SUMMARY
          echo "2. Remove secrets from Git history using BFG or git-filter-repo" >> $GITHUB_STEP_SUMMARY
          echo "3. Update .gitleaks.toml if false positive" >> $GITHUB_STEP_SUMMARY
          echo "4. Review and update secret management practices" >> $GITHUB_STEP_SUMMARY
