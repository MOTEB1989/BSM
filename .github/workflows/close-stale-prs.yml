name: Close All Stale PRs

on:
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  close-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Close all open PRs
        uses: actions/github-script@v7
        with:
          script: |
            const prs = [];
            let page = 1;
            
            // Collect all open PRs
            while (true) {
              const result = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100,
                page: page
              });
              
              if (result.data.length === 0) break;
              prs.push(...result.data);
              page++;
            }
            
            console.log(`Found ${prs.length} open PRs to close`);
            
            const comment = `## üßπ ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ©
            
            ÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ÿ∂ŸÖŸÜ ÿπŸÖŸÑŸäÿ© ÿ™ŸÜÿ∏ŸäŸÅ ÿ¥ÿßŸÖŸÑÿ© ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿπŸÑŸÇÿ© ŸàÿßŸÑŸÇÿØŸäŸÖÿ©.
            
            ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ™ÿ∫ŸäŸäÿ±ÿßÿ™ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ∑ŸÑÿ® ŸÑÿß ÿ™ÿ≤ÿßŸÑ ŸÖÿ∑ŸÑŸàÿ®ÿ©ÿå Ÿäÿ±ÿ¨Ÿâ ŸÅÿ™ÿ≠ PR ÿ¨ÿØŸäÿØ.`;
            
            let closed = 0;
            let failed = 0;
            
            for (const pr of prs) {
              try {
                // Add comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: comment
                });
                
                // Close PR
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  state: 'closed'
                });
                
                console.log(`‚úÖ Closed PR #${pr.number}: ${pr.title}`);
                closed++;
                
                // Rate limiting - wait 1 second between operations
                await new Promise(r => setTimeout(r, 1000));
                
              } catch (error) {
                console.log(`‚ùå Failed to close PR #${pr.number}: ${error.message}`);
                failed++;
              }
            }
            
            console.log(`\n========================================`);
            console.log(`‚úÖ Closed: ${closed}`);
            console.log(`‚ùå Failed: ${failed}`);
            console.log(`üìä Total: ${prs.length}`);
