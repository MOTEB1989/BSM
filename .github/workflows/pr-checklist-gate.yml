name: PR Checklist Gate

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

permissions:
  pull-requests: read
  contents: read

jobs:
  enforce-pr-checklist:
    name: Enforce PR Checklist Completeness
    runs-on: ubuntu-latest

    steps:
      - name: Validate mandatory checklist and rollback section
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            const requiredChecks = [
              'Lint pass',
              'Build pass',
              'Tests pass \(if tests exist\)',
              'No secrets in code, logs, commits, or PR description',
              'Migration notes added \(required only if DB schema/data changed\)'
            ];

            const missingChecks = [];
            for (const label of requiredChecks) {
              const checkboxPattern = new RegExp(`- \\[xX\\]\\s+${label}`);
              if (!checkboxPattern.test(body)) {
                missingChecks.push(label.replace(/\\/g, ''));
              }
            }

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              per_page: 100
            });

            const changedPaths = files.map(f => f.filename);
            const touchesApiOrDb = changedPaths.some((path) =>
              path.startsWith('server/api/') ||
              /(^|\/)migrations?\//i.test(path) ||
              /(^|\/)db\//i.test(path) ||
              /(schema\.sql|\.sql$|prisma\/schema\.prisma$)/i.test(path)
            );

            const hasRiskSection = /##\s+Risk\s*&\s*Rollback/i.test(body);
            const hasRiskSubsections =
              /###\s+Risk/i.test(body) &&
              /###\s+Rollback Plan/i.test(body) &&
              /###\s+Monitoring\s*\/\s*Verification/i.test(body);

            const errors = [];

            if (missingChecks.length > 0) {
              errors.push(`Mandatory checklist items are incomplete: ${missingChecks.join(', ')}`);
            }

            if (touchesApiOrDb && (!hasRiskSection || !hasRiskSubsections)) {
              errors.push('PR touches server/api or database files, but "Risk & Rollback" section is missing or incomplete.');
            }

            if (errors.length > 0) {
              core.setFailed([
                'PR Checklist Gate failed:',
                ...errors.map((e) => `- ${e}`)
              ].join('\n'));
              return;
            }

            core.info('PR checklist and Risk & Rollback requirements are satisfied.');
